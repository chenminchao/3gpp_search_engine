
                                            3GPP TS 32.299 V16.1.0 (2019-06)
                                                     Technical Specification
                                         3rd Generation Partnership Project;
                  Technical Specification Group Services and System Aspects;
                                               Telecommunication management;
                                                        Charging management;
                                              Diameter charging applications
                                                                (Release 16)
[pic]  [pic]
The  present  document  has  been  developed  within  the   3rd   Generation
Partnership Project  (3GPP  TM)  and  may  be  further  elaborated  for  the
purposes of 3GPP.
The present document has not been subject to any  approval  process  by  the
3GPP Organizational Partners and shall not be implemented.
This Specification is provided  for  future  development  work  within  3GPP
only. The Organizational Partners accept no liability for any  use  of  this
Specification.
Specifications and reports for implementation of the 3GPP TM  system  should
be obtained via the 3GPP Organizational Partners' Publications Offices.








                                  Keywords
                  charging, management, protocol, Diameter


                                    3GPP

                               Postal address



                         3GPP support office address
                  650 Route des Lucioles - Sophia Antipolis
                              Valbonne - FRANCE
               Tel.: +33 4 92 94 42 00 Fax: +33 4 93 65 47 16

                                  Internet
                             http://www.3gpp.org


                           Copyright Notification

    No part may be reproduced except as authorized by written permission.
  The copyright and the foregoing restriction extend to reproduction in all
                                   media.

  © 2019, 3GPP Organizational Partners (ARIB, ATIS, CCSA, ETSI, TSDSI, TTA,
                                    TTC).
                            All rights reserved.

UMTS™ is a Trade Mark of ETSI registered for the benefit of its members
3GPP™ is a Trade Mark of ETSI registered for the benefit of its Members and
of the 3GPP Organizational Partners
LTE™ is a Trade Mark of ETSI registered for the benefit of its Members and
of the 3GPP Organizational Partners
GSM® and the GSM logo are registered and owned by the GSM Association




         Contents


Foreword 13

1  Scope 14

2  References 15

3  Definitions, symbols and abbreviations  17
3.1  Definitions  17
3.2  Symbols  18
3.3  Abbreviations  18

4  Architecture considerations  20
4.1  High level architecture 20
4.1.0  General  20
4.1.1  Charging related transfer requirements  21

5  3GPP charging applications requirements 22
5.1  Offline charging scenarios 22
5.1.1  Basic principles  22
5.1.1.0  Introduction  22
5.1.1.1  Event based charging   23
5.1.1.2  Session based charging 24
5.1.2  Basic operation 26
5.2  Online charging scenarios  27
5.2.0  Introduction 27
5.2.1  Basic principles  27
5.2.2  Charging scenarios  28
5.2.2.0  Introduction  28
5.2.2.1  Immediate Event Charging (IEC) 29
5.2.2.1.1   Decentralized Unit Determination and Centralized Rating  29
5.2.2.1.2   Centralized Unit Determination and Centralized Rating  31
5.2.2.1.3   Decentralized Unit Determination and Decentralized Rating  33
5.2.2.1.4   Further options  34
5.2.2.2  Event Charging with Unit Reservation (ECUR)  35
5.2.2.2.1   Decentralized Unit Determination and Centralized Rating  35
5.2.2.2.2   Centralized Unit Determination and Centralized Rating  37
5.2.2.2.3   Decentralized Unit Determination and Decentralized Rating  39
5.2.2.3  Session charging with Reservation 41
5.2.2.3.1   Decentralized Unit Determination and Centralized Rating  41
5.2.2.3.2   Centralized Unit Determination and Centralized Rating  43
5.2.2.3.3   Decentralized Unit Determination and Decentralized Rating  45
5.2.3  Basic operations  47
5.3  Other requirements  50
5.3.1  Re-authorization  50
5.3.2  Threshold based re-authorization triggers 50
5.3.3  Termination action  50
5.3.4  Account expiration  50

6  3GPP charging applications – Protocol aspects 51
6.1  Basic principles for Diameter offline charging 51
6.1.0  Introduction 51
6.1.1  Event based charging  52
6.1.2  Session based charging   53
6.1.3  Offline charging error cases - Diameter procedures 55
6.1.3.1  CDF connection failure 55
6.1.3.2  No reply from CDF 55
6.1.3.3  Duplicate detection 55
6.1.3.4  CDF detected failure   55
6.2  Message contents for offline charging 56
6.2.1  Summary of offline charging message formats  56
6.2.1.1  General  56
6.2.1.2  Structure for the Accounting message formats 56
6.2.2  Accounting-Request message 57
6.2.3  Accounting-Answer (ACA) message  59
6.3  Basic principles for Diameter online charging  61
6.3.1  Online Specific Credit-Control application requirements 61
6.3.2  Diameter description on the Ro reference point 61
6.3.2.1  Basic principles  61
6.3.3  Immediate Event Charging (IEC) 62
6.3.4  Event Charging with Unit Reservation (ECUR)  64
6.3.5  Session Charging with Unit Reservation (SCUR)  66
6.3.6  Error cases and scenarios  68
6.3.6.0  Introduction  68
6.3.6.1  Duplicate detection 68
6.3.6.2  Reserve Units / Debit Units operation failure  68
6.3.7  Support of tariff changes during an active user session 68
6.3.7.1  Support of tariff changes using the tariff switch mechanism 68
6.3.7.2  Support of tariff changes using Validity-Time AVP  68
6.3.8  Support of re-authorization  69
6.3.9  Support of failure handling  69
6.3.10 Support of failover 69
6.3.11 Credit pooling  69
6.4  Message formats for online charging   70
6.4.1  Summary of online charging message formats   70
6.4.1.1  General  70
6.4.1.2  Structure for the Credit-Control message formats 70
6.4.2  Credit-Control-Request message 71
6.4.3  Credit-Control-Answer message  76
6.4.4  Re-Auth-Request message  81
6.4.5  Re-Auth-Answer message   82
6.4.6  Capabilities-Exchange-Request message 82
6.4.7  Capabilities-Exchange-Answer message  83
6.4.8  Device-Watchdog-Request message  83
6.4.9  Device-Watchdog-Answer message 83
6.4.10 Disconnect-Peer-Request message  83
6.4.11 Disconnect-Peer-Answer message 83
6.4.12 Abort-Session-Request message  83
6.4.13 Abort-Session -Answer message  83
6.5  Other procedural description of the 3GPP charging applications  84
6.5.1  Re-Authorization  84
6.5.1.1  Idle timeout  84
6.5.1.2  Change of charging conditions  84
6.5.1.3  Reporting quota usage  84
6.5.1.4  Quota consumption 85
6.5.2  Threshold based Re-Authorization triggers 85
6.5.3  Termination action  85
6.5.4  Quota consumption time   86
6.5.5  Service termination 86
6.5.6  Envelope reporting  86
6.5.6.1  Envelope reporting in Online Charging 86
6.5.6.2  Envelope reporting in Offline Charging  86
6.5.6.3  Envelope reporting - Quota consumption time  87
6.5.6.4  Envelope reporting - Combinational quota   87
6.5.7  Combinational quota 88
6.5.8  Online control of offline charging information 88
6.5.9  Support of multiple service  88
6.5.10 Supported Features mechanism 88
6.5.10.1 Introduction  88
6.5.10.2 Defining a feature  88
6.5.10.3 Supported Feature handling 89
6.6  Bindings of the operation to protocol application  90
6.6.0  General  90
6.6.1  Bindings of Charging Data Transfer to Accounting 90
6.6.2  Bindings of Debit / Reserve Units to Credit-Control  91
6.7  Securing Diameter messages 91

7  Summary of used Attribute Value Pairs   92
7.1  Diameter AVPs  92
7.1.0  General  92
7.1.1  Accounting-Input-Octets AVP  93
7.1.2  Void 94
7.1.3  Accounting-Output-Octets AVP 94
7.1.4  Void 94
7.1.5  Acct-Application-Id AVP  94
7.1.6  Auth-Application-Id AVP  94
7.1.7  Called-Station-Id AVP 94
7.1.8  Event-Timestamp AVP 94
7.1.8A Experimental-Result AVP  94
7.1.9  Multiple-Services-Credit-Control AVP  94
7.1.10 Rating-Group AVP  95
7.1.11 Result-Code AVP 95
7.1.12 Service-Context-Id AVP   96
7.1.13 Service-Identifier AVP   96
7.1.14 Used-Service-Unit AVP 96
7.1.15 User-Name AVP   97
7.1.16 Vendor-Id AVP   97
7.1.17 User-Equipment-Info AVP  97
7.2  3GPP specific AVPs  98
7.2.0  General  98
7.2.0A Access-Network-Info-Change AVP 107
7.2.0aA  3GPP-PS-Data-Off-Status AVP  107
7.2.1  Access-Network-Information AVP 107
7.2.1A Access-Transfer-Information AVP  108
7.2.1B Access-Transfer-Type AVP 108
7.2.2  Account-Expiration AVP   108
7.2.3  Accumulated-Cost AVP  108
7.2.4  Adaptations AVP 108
7.2.5  Additional-Content-Information AVP  108
7.2.5A Additional-Exception-Reports AVP 109
7.2.6  Additional-Type-Information AVP  109
7.2.7  Address-Data AVP  109
7.2.8  Address-Domain AVP  109
7.2.9  Address-Type AVP  109
7.2.10 Addressee-Type AVP  109
7.2.11 AF-Correlation-Information AVP 110
7.2.12 Alternate-Charged-Party-Address AVP 110
7.2.12aA Announcement-Identifier AVP  110
7.2.12aB Announcement-Information AVP 110
7.2.12aC Announcement-Order AVP 110
7.2.12aD Announcing-PLMN-ID AVP 110
7.2.12A  Announcing-UE-HPLMN-Identifier AVP  111
7.2.12B  Announcing-UE-VPLMN-Identifier AVP  111
7.2.13 AoC-Cost-Information AVP 111
7.2.14 AoC-Format AVP  111
7.2.15 AoC-Information AVP 111
7.2.16 AoC-Request-Type AVP  111
7.2.17 AoC-Service AVP 111
7.2.18 AoC-Service-Obligatory-Type AVP  112
7.2.19 AoC-Service-Type AVP  113
7.2.20 AoC-Subscription-Information AVP 113
7.2.20aA API-Content AVP 113
7.2.20bA API-Direction AVP 113
7.2.20cA API-Identifier AVP  113
7.2.20dA API-Invocation-Timestamp AVP 113
7.2.20eA API-Network-Service-Node AVP 113
7.2.20fA API-Result-Code AVP 113
7.2.20gA API-Size AVP  113
7.2.20A  APN-Rate-Control   AVP 114
7.2.20B  APN-Rate-Control-Downlink   AVP   114
7.2.20C  APN-Rate-Control-Uplink   AVP  114
7.2.21 Applic-ID AVP   114
7.2.22 Application-Provided-Called-Party-Address AVP  114
7.2.23 Application-Server AVP   115
7.2.24 Application-Server-Information AVP  115
7.2.24A  Application-Specific-Data AVP  115
7.2.25 Associated-Party-Address AVP 116
7.2.26 Associated-URI AVP  116
7.2.27 Authorised-QoS AVP  116
7.2.28 Aux-Applic-Info AVP 116
7.2.29 Base-Time-Interval AVP   116
7.2.29A  Basic-Service-Code AVP 116
7.2.29B  Bearer-Capability AVP  116
7.2.30 Bearer-Service AVP  116
7.2.30A  BSSID AVP  116
7.2.31 Called-Asserted-Identity AVP 117
7.2.31A  Called-Identity AVP 117
7.2.31B  Called-Identity-Change AVP 117
7.2.32 Called-Party-Address AVP 117
7.2.33 Calling-Party-Address AVP  117
7.2.34 Carrier-Select-Routing-Information AVP  118
7.2.35 Cause-Code AVP  119
7.2.35A  Cellular-Network-Information AVP  120
7.2.35B  Civic-Address-Information AVP  120
7.2.36 CG-Address AVP  120
7.2.37 Change-Condition AVP  120
7.2.38 Change-Time AVP 121
7.2.38A  Charge-Reason-Code AVP 121
7.2.39 Charged-Party AVP 122
7.2.39A  Charging-Characteristics-Selection-Mode AVP  122
7.2.39B  Charging-Per-IP-CAN-Session-Indicator AVP  122
7.2.40 Class-Identifier AVP  122
7.2.41 Client-Address AVP  122
7.2.41A  CN-Operator-Selection-Entity AVP  122
7.2.42 Content-Class AVP 123
7.2.43 Content-Disposition AVP  123
7.2.44 Content-Length AVP  123
7.2.45 Content-Size AVP  123
7.2.46 Content-Type AVP  123
7.2.46aA Coverage-Status AVP 123
7.2.46aaA   Coverage-Info AVP   123
7.2.46abA   CP-CIoT-EPS-Optimisation-Indicator AVP  124
7.2.46acA   CPDT-Information AVP  124
7.2.46A  CSG-Access-Mode AVP 124
7.2.46B  CSG-Membership-Indication AVP  124
7.2.47 Current-Tariff AVP  125
7.2.48 CUG-Information AVP 125
7.2.49 Data-Coding-Scheme AVP   125
7.2.50 DCD-Information AVP 125
7.2.51 Deferred-Location-Event-Type AVP 125
7.2.52 Delivery-Report-Requested AVP  125
7.2.53 Destination-Interface AVP  125
7.2.54 Diagnostics AVP 126
7.2.54A  Discoveree-UE-HPLMN-Identifier AVP  126
7.2.54B  Discoveree-UE-VPLMN-Identifier AVP  126
7.2.54C  Discoverer-UE-HPLMN-Identifier AVP  126
7.2.54D  Discoverer-UE-VPLMN-Identifier AVP  126
7.2.55 Domain-Name AVP 126
7.2.56 DRM-Content AVP 126
7.2.57 Dynamic-Address-Flag AVP 126
7.2.57A  Dynamic-Address-Flag-Extension AVP  126
7.2.58 Early-Media-Description AVP  127
7.2.58A  Enhanced-Diagnostics AVP 127
7.2.59 Envelope AVP 127
7.2.60 Envelope-End-Time AVP 128
7.2.61 Envelope-Reporting AVP   129
7.2.62 Envelope-Start-Time AVP  129
7.2.62A    EPDG-Address AVP  129
7.2.63 Event AVP  129
7.2.64 Event-Charging-TimeStamp AVP 129
7.2.65 Event-Type AVP  129
7.2.66 Expires AVP  129
7.2.66A  FE-Identifier-List AVP 129
7.2.66aA Exposure-Function-API-Information AVP 130
7.2.67 File-Repair-Supported AVP  131
7.2.67aA Forwarding-Pending AVP 131
7.2.67A  From-Address AVP  131
7.2.68 GGSN-Address AVP  131
7.2.69 IM-Information AVP  131
7.2.70 Incremental-Cost AVP  131
7.2.70A  Instance-Id AVP 131
7.2.71 Interface-Id AVP  131
7.2.72 Interface-Port AVP  132
7.2.73 Interface-Text AVP  132
7.2.74 Interface-Type AVP  132
7.2.74aA Inter-UE-Transfer AVP  132
7.2.74A  IMS-Application-Reference-Identifier AVP   132
7.2.75 IMS-Charging-Identifier AVP  132
7.2.76 IMS-Communication-Service-Identifier AVP  132
7.2.76A  IMS-Emergency-Indicator AVP  132
7.2.77 IMS-Information AVP 133
7.2.77A  IMS-Visited-Network-Identifier AVP  134
7.2.78 IMSI-Unauthenticated-Flag AVP  134
7.2.79 Incoming-Trunk-Group-ID AVP  134
7.2.79A  Initial-IMS-Charging-Identifier AVP 134
7.2.80 Inter-Operator-Identifier AVP  134
7.2.80A  IP-Realm-Default-Indication AVP   134
7.2.80B  ISUP-Cause AVP  134
7.2.80C  ISUP-Cause-Diagnostics AVP 135
7.2.80D  ISUP-Cause-Location AVP  135
7.2.80E  ISUP-Cause-Value AVP   135
7.2.80F  ISUP-Location-Number AVP 135
7.2.80Fa Language AVP  135
7.2.80G  Layer-2-Group-ID AVP   135
7.2.81 LCS-APN AVP  135
7.2.82 LCS-Client-Dialed-By-MS AVP  135
7.2.83 LCS-Client-External-ID AVP 135
7.2.84 LCS-Client-ID AVP 135
7.2.85 LCS-Client-Name AVP 137
7.2.86 LCS-Client-Type AVP 137
7.2.87 LCS-Data-Coding-Scheme AVP 137
7.2.88 LCS-Format-Indicator AVP 137
7.2.89 LCS-Information AVP 137
7.2.90 LCS-Name-String AVP 137
7.2.91 LCS-Requestor-ID AVP  138
7.2.92 LCS-Requestor-ID-String AVP  138
7.2.92A  Local-GW-Inserted-Indication AVP  138
7.2.93 Local-Sequence-Number AVP  138
7.2.94 Location-Estimate AVP 138
7.2.95 Location-Estimate-Type AVP 138
7.2.95A  Location-Info AVP 138
7.2.96 Location-Type AVP 139
7.2.97 Low-Balance-Indication AVP 139
7.2.97A  Low-Priority-Indicator AVP 139
7.2.97B  MBMS-Charged-Party AVP 139
7.2.98 MBMS-GW-Address AVP 139
7.2.99 MBMS-Information AVP  139
7.2.100  MBMS-User-Service-Type AVP 140
7.2.101  Media-Initiator-Flag AVP 141
7.2.102  Media-Initiator-Party AVP  141
7.2.103  Message-Body AVP  141
7.2.104  Message-Class AVP 141
7.2.105  Message-ID AVP  141
7.2.106  Message-Size AVP  141
7.2.107  Message-Type AVP  142
7.2.108  MM-Content-Type AVP 142
7.2.109  MMBox-Storage-Requested AVP  142
7.2.110  MMS-Information AVP 143
7.2.111  MMTel-Information AVP  143
7.2.111A  MMTel-SService-Type AVP 143
7.2.111Aa    Monitored-PLMN-Identifier AVP 144
7.2.111AaA  Monitoring-Event-Configuration-Activity AVP 144
7.2.111AaB  Monitoring-Event-Functionality AVP 144
7.2.111AaC  Monitoring-Event-Information AVP 144
7.2.111AaD  Monitoring-Event-Report-Data AVP 145
7.2.111AaE  Monitoring-Event-Report-Number AVP 145
7.2.111Ab   Monitoring-UE-HPLMN-Identifier AVP 145
7.2.111Ac   Monitoring-UE-Identifier AVP   145
7.2.111Ad   Monitoring-UE-VPLMN-Identifier AVP 145
7.2.111B MSC-Address AVP 145
7.2.111C MTC-IWF-Address AVP 145
7.2.111D Neighbour-Node-Address AVP 145
7.2.111E Network-Call-Reference-Number AVP 146
7.2.112  Next-Tariff AVP 146
7.2.112aA   NIDD-Submission  AVP  146
7.2.112A NNI-Information AVP 146
7.2.112B NNI-Type AVP  147
7.2.113  Node-Functionality AVP 147
7.2.114  Node-Id AVP   147
7.2.115  Number-Of-Diversions AVP 147
7.2.116  Number-Of-Messages-Sent AVP  147
7.2.117  Number-Of-Participants AVP 147
7.2.118  Number-Of-Received-Talk-Bursts AVP  148
7.2.119  Number-Of-Talk-Bursts AVP  148
7.2.120  Number-Portability-Routing-Information AVP 148
7.2.121  Offline-Charging AVP   148
7.2.122  Online-Charging-Flag AVP 148
7.2.123  Originating-IOI AVP 149
7.2.124  Originator AVP  149
7.2.125  Originator-Address AVP 149
7.2.126  Originator-Interface AVP 150
7.2.127  Originator-Received-Address AVP   150
7.2.128  Originator-SCCP-Address  150
7.2.128A Outgoing-Session-Id AVP  150
7.2.129  Outgoing-Trunk-Group-ID AVP  150
7.2.130  Participants-Involved AVP  150
7.2.131  Participant-Group AVP  151
7.2.132  Participant-Access-Priority AVP   151
7.2.133  Participant-Action-Type AVP  151
7.2.134  Void 151
7.2.135  Void 151
7.2.135A PC3-Control-Protocol-Cause AVP 151
7.2.135B PC3-EPC-Control-Protocol-Cause AVP  151
7.2.136  PDN-Connection-Charging-ID AVP 153
7.2.137  PDP-Address AVP 153
7.2.137A PDP-Address-Prefix-Length AVP  153
7.2.138  PDP-Context-Type AVP   153
7.2.138A Play-Alternative AVP   153
7.2.139  PoC-Change-Condition AVP 153
7.2.140  PoC-Change-Time AVP 153
7.2.141  PoC-Controlling-Address AVP  154
7.2.142  PoC-Event-Type AVP  155
7.2.143  PoC-Group-Name AVP  155
7.2.144  PoC-Information AVP 155
7.2.145  PoC-Server-Role AVP 155
7.2.146  PoC-Session-Id AVP  155
7.2.147  PoC-Session-Initiation-Type AVP   156
7.2.148  PoC-Session-Type AVP   156
7.2.149  PoC-User-Role AVP 156
7.2.150  PoC-User-Role-IDs AVP  156
7.2.151  PoC-User-Role-Info-Units AVP 156
7.2.152  Positioning-Data AVP   156
7.2.153  Preferred-AoC-Currency AVP 156
7.2.154  Priority AVP  157
7.2.154aA   Privacy-Indicator AVP 157
7.2.154A ProSe-3rd-Party-Application-ID AVP  157
7.2.154Aa   ProSe-Direct-Communication-Reception-Data-Container AVP  157
7.2.154B ProSe-Direct-Communication-Transmission-Data-Container AVP  157
7.2.154C ProSe-Direct-Discovery-Model AVP  158
7.2.154D ProSe-Event-Type AVP   158
7.2.154E ProSe-Function-IP-Address AVP  158
7.2.154F ProSe-Function-PLMN-Identifier AVP  158
7.2.154G ProSe-Functionality AVP  158
7.2.154H ProSe-Group-IP-Multicast-Address AVP  158
7.2.154I ProSe-Information AVP  158
7.2.154J ProSe-Range-Class AVP  159
7.2.154K ProSe-Reason-For-Cancellation AVP 160
7.2.154L ProSe-Request-Timestamp AVP  160
7.2.154M  ProSe-Role-Of-UE AVP  160
7.2.154N ProSe-Source-IP-Address AVP  160
7.2.154O ProSe-UE-ID AVP 160
7.2.154Oa   ProSe-UE-to-Network-Relay-UE-ID AVP  160
7.2.154Ob   ProSe-Target-Layer-2-ID AVP 160
7.2.154P Proximity-Alert-Indication AVP 161
7.2.154Q Proximity-Alert-Timestamp AVP  161
7.2.154R Proximity-Cancellation-Timestamp AVP  161
7.2.155  PS-Append-Free-Format-Data AVP 161
7.2.156  PS-Free-Format-Data AVP  161
7.2.157  PS-Furnish-Charging-Information AVP 161
7.2.158  PS-Information AVP  161
7.2.159  Quota-Consumption-Time AVP 163
7.2.160  Quota-Holding-Time AVP 163
7.2.160aA   Quota-Indicator AVP 163
7.2.160A Radio-Frequency AVP 163
7.2.160B Radio-Parameter-Set-Info AVP 163
7.2.160C Radio-Parameter-Set-Values AVP 164
7.2.160D Radio-Resources-Indicator AVP  164
7.2.160Da   RAN-End-Timestamp AVP 164
7.2.160Db   RAN-Secondary-RAT-Usage-Report AVP 164
7.2.160Dc   RAN-Start-Timestamp AVP 164
7.2.160E   Rate-Control-Max-Message-Size AVP 164
7.2.160F   Rate-Control-Max-Rate AVP  164
7.2.160G Rate-Control-Time-Unit AVP 165
7.2.161  Rate-Element AVP  165
7.2.162  Read-Reply-Report-Requested AVP   165
7.2.163  Void 165
7.2.164  Real-Time-Tariff-Information AVP  166
7.2.164A Reason-Header AVP 166
7.2.165  Received-Talk-Burst-Time AVP 166
7.2.166  Received-Talk-Burst-Volume AVP 166
7.2.167  Recipient-Address AVP  166
7.2.168  Recipient-Info AVP  167
7.2.169  Recipient-Received-Address AVP 167
7.2.170  Recipient-SCCP-Address 167
7.2.171  Refund-Information AVP 167
7.2.171A Relationship-Mode AVP  167
7.2.171Aa   Related-Change-Condition-Information AVP  168
7.2.171Ab   Related-Trigger AVP 168
7.2.171B Related-IMS-Charging-Identifier AVP 168
7.2.171C Related-IMS-Charging-Identifier-Node AVP   168
7.2.171D Relay-IP-address AVP   168
7.2.172  Remaining-Balance AVP  168
7.2.173  Reply-Applic-ID AVP 169
7.2.174  Reply-Path-Requested AVP 169
7.2.175  Reporting-Reason AVP   170
7.2.176  Requested-Party-Address AVP  171
7.2.176A Requested-PLMN-Identifier AVP  171
7.2.176B Requestor-PLMN-Identifier AVP  171
7.2.177  Role-Of-Node AVP  171
7.2.177aA   Role-Of-ProSe-Function AVP  171
7.2.177A Route-Header-Received AVP  171
7.2.177B Route-Header-Transmitted AVP 171
7.2.178  Scale-Factor AVP  172
7.2.178aA   SCEF-Address AVP 172
7.2.178A SCS-Address AVP 172
7.2.178B SCS-AS-Address AVP  172
7.2.178C SCS-Realm AVP 172
7.2.179  SDP-Answer-Timestamp AVP 172
7.2.180  SDP-Media-Component AVP  172
7.2.181  SDP-Media-Description AVP  173
7.2.182  SDP-Media-Name AVP  173
7.2.183  SDP-Offer-Timestamp AVP  173
7.2.184  SDP-Session-Description AVP  173
7.2.185  SDP-TimeStamps AVP  173
7.2.186  SDP-Type AVP  173
7.2.186A Session-Direction AVP  173
7.2.187  Served-Party-IP-Address AVP  174
7.2.188  Void 174
7.2.188A Secondary-RAT-Type AVP 174
7.2.189  Service-Data-Container AVP 174
7.2.190  Service-ID AVP  175
7.2.191  Service-Generic-Information AVP   175
7.2.192  Service-Information AVP  175
7.2.193  Service-Mode AVP  176
7.2.194  Service-Specific-Data AVP  176
7.2.195  Service-Specific-Info AVP  176
7.2.196  Service-Specific-Type AVP  176
7.2.197  Void 176
7.2.197a    Serving-Node-Identity 176
7.2.198  Serving-Node-Type AVP  177
7.2.198A SGi-PtP-Tunnelling-Method AVP  177
7.2.199  SGSN-Address AVP  177
7.2.199A SGW-Address AVP 177
7.2.200  SGW-Change AVP  177
7.2.201  SIP-Method AVP  177
7.2.202  SIP-Request-Timestamp AVP  177
7.2.203  SIP-Request-Timestamp-Fraction AVP  177
7.2.204  SIP-Response-Timestamp AVP 178
7.2.205  SIP-Response-Timestamp-Fraction AVP 178
7.2.205A SM-Device-Trigger-Indicator AVP   178
7.2.205B SM-Device-Trigger-Information AVP 178
7.2.206  SM-Discharge-Time AVP  178
7.2.207  SM-Message-Type AVP 178
7.2.208  SM-Protocol-Id AVP  179
7.2.208A SM-Sequence-Number AVP 179
7.2.209  SM-Status AVP 179
7.2.210  SM-User-Data-Header AVP  179
7.2.211  SMS-Information AVP 179
7.2.212  SMS-Node AVP  180
7.2.212A SMS-Result AVP  180
7.2.213  SM-Service-Type AVP 181
7.2.214  SMSC-Address AVP  181
7.2.214A Start-of-Charging AVP  181
7.2.215  Start-Time AVP  181
7.2.215A Status-AS-Code AVP  181
7.2.216  Stop-Time AVP 181
7.2.217  Submission-Time AVP 182
7.2.218  Subscriber-Role AVP 182
7.2.219  Supplementary-Service AVP  182
7.2.219A TAD-Identifier AVP  182
7.2.220  Talk-Burst-Exchange AVP  182
7.2.221  Talk-Burst-Time AVP 183
7.2.222  Talk-Burst-Volume AVP  183
7.2.222A Target-IP-Address AVP  183
7.2.223  Tariff-Information AVP 183
7.2.224  Tariff-XML AVP  183
7.2.224A Teleservice AVP 183
7.2.225  Terminating-IOI AVP 183
7.2.225A Time-First-Reception AVP 184
7.2.225B Time-First-Transmission AVP  184
7.2.226  Time-First-Usage AVP   184
7.2.226A Time-Indicator AVP  184
7.2.227  Time-Last-Usage AVP 184
7.2.228  Time-Quota-Mechanism   184
7.2.229  Time-Quota-Threshold AVP 185
7.2.230  Time-Quota-Type AVP 185
7.2.231  Time-Stamps AVP 185
7.2.232   Time-Usage AVP 185
7.2.232A TLTRI AVP  185
7.2.233  Traffic-Data-Volumes AVP 185
7.2.233A Transcoder-Inserted-Indication AVP  186
7.2.233B Transit-IOI-List AVP   186
7.2.233C Transmitter-Info AVP   186
7.2.234  Token-Text AVP  186
7.2.235  Trigger AVP   186
7.2.236  Trigger-Type AVP  187
7.2.237  Trunk-Group-ID AVP  190
7.2.237aA   Void  190
7.2.237A Void 190
7.2.237B Void 190
7.2.237Ba   TWAG-Address AVP 190
7.2.237C TWAN-User-Location-Info AVP  191
7.2.238  Type-Number AVP 191
7.2.238A UNI-PDU-CP-Only-Flag AVP 191
7.2.239  Unit-Cost AVP 191
7.2.240  Unit-Quota-Threshold AVP 191
7.2.240a Unused-Quota-Timer AVP 192
7.2.240A User-CSG-Information AVP 192
7.2.240B Usage-Information-Report-Sequence-Number AVP 192
7.2.241  User-Participating-Type AVP  192
7.2.242  User-Session-Id AVP 192
7.2.242aaA  UWAN-User-Location-Info AVP 192
7.2.242aA   Variable-Part AVP   193
7.2.242aB   Variable-Part-Order AVP 193
7.2.242aC   Variable-Part-Type AVP  193
7.2.242aD   Variable-Part-Value AVP 193
7.2.242A VCS-Information AVP 193
7.2.242B VLR-Number AVP  194
7.2.243  Volume-Quota-Threshold AVP 194
7.2.244  Void 194
7.2.245  Void 194
7.2.246  Void 194
7.2.247  Void 194
7.2.248  Void 194
7.2.249  Void 194
7.2.250  Void 195
7.2.251  WLAN-Operator-Id AVP   195
7.2.252  WLAN-Operator-Name AVP 195
7.2.253  WLAN-PLMN-Id AVP  195
7.3  3GPP2 specific AVPs 196
7.4  ETSI specific AVPs  196
7.5  oneM2M specific AVPs  196

Annex A (informative): Bibliography 197

Annex B (normative):   3GPP Charging Diameter Overload Control 198

B.1  DOIC (Diameter Overload Indication Conveyance) 198
B.1.0  General  198
B.1.1  Reporting node  198
B.1.2  Reacting node   198

B.2  Diameter overload AVPs  198
B.2.0  General  198
B.2.1  3GPP-OC-Rating-Group AVP 199
B.2.2  3GPP-OC-Request-Type AVP 199
B.2.3  3GPP-OC-Specific-Reduction AVP 199
B.2.4  OC-OLR AVP 199

Annex C (informative): Change history 200




         Foreword

This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).

The contents of the present document are subject to continuing work within
the TSG and may change following formal TSG approval. Should the TSG modify
the contents of the present document, it will be re-released by the TSG
with an identifying change of release date and an increase in version
number as follows:

  Version x.y.z

  where:

    x  the first digit:

       1  presented to TSG for information;

       2  presented to TSG for approval;

       3  or greater indicates TSG approved document under change control.

    y  the second digit is incremented for all changes of substance, i.e.
       technical enhancements, corrections, updates, etc.

    z  the third digit is incremented when editorial only changes have been
       incorporated in the document.



         1  Scope

The present document is part of a series of Technical Specifications (TSs)
that specify charging functionality and charging management in GSM/UMTS
networks. The GSM/UMTS core network-charging architecture and principles
are specified in TS 32.240 [1], which provides an umbrella for other
charging management documents that specify.

  -  The content of the CDRs' per domain and subsystem (offline charging);

  -  The content of real-time charging messages per domain / subsystem
    (online charging);

  -  The functionality of online and offline charging for those domains and
    subsystems;

  -  The interfaces that are used in the charging framework to transfer the
    charging information (i.e. CDRs or charging events).

The complete document structure for these TSs is defined in TS 32.240 [1].

The present document specifies in detail the Diameter based offline and
online charging applications for 3GPP networks. It includes all charging
parameters, scenarios and message flows..

All terms, definitions and, abbreviations used in the present document,
that are common across 3GPP TSs, are defined in TR 21.905 [100]. Those that
are common across charging management in GSM/UMTS domains, services or
subsystems are provided in the umbrella document TS 32.240 [1] and are
copied into clause 3 of the present document for ease of reading. Finally,
those items that are specific to the present document are defined
exclusively in the present document.

Furthermore, requirements that govern the charging work are specified in TS
22.115 [101].



         2  References

The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.

  -  References are either specific (identified by date of publication,
    edition number, version number, etc.) or non-specific.

  -  For a specific reference, subsequent revisions do not apply.

  -  For a non-specific reference, the latest version applies.  In the case
    of a reference to a 3GPP document (including a GSM document), a non-
    specific reference implicitly refers to the latest version of that
    document in the same Release as the present document.

  [1]  3GPP TS 32.240: "Telecommunication management; Charging management;
             Charging architecture and principles ".

  [2] - [10]  Void.

  [11] 3GPP TS 32.251: "Telecommunication management; Charging management;
             Packet Switched (PS) domain charging".

  [12]   Void.

  [13] 3GPP TS 32.253: "Telecommunication management; Charging management;
             Control Plane (CP) data transfer domain charging".

  [14] - [99] Void.

  [100]  3GPP TR 21.905: "Vocabulary for 3GPP Specifications".

  [101]  3GPP TS 22.115: "Service aspects; Charging and billing".

  [102] - [199] Void.

  [200]  3GPP TS 23.207: "End to end quality of service concept and
             architecture".

  [201]  3GPP TS 23.228: "IP Multimedia Subsystem (IMS); Stage 2".

  [202]  3GPP TS 24.229: "IP Multimedia Call Control Protocol based on SIP
             and SDP; Stage 3".

  [203]  3GPP TS 29.207: "Policy control over Go interface".

  [204]  3GPP TS 29.229: "Cx and Dx Interfaces based on the Diameter
             protocol; Protocol Details".

  [205]  Void.

  [206]  3GPP TS 29.230: "3GPP specific codes and identifiers".

  [207]  3GPP TS 29.061: "Interworking between the Public Land Mobile
             Network (PLMN) supporting packet based services and Packet
             Data Networks (PDN)".

  [208]  3GPP TS 23.140: " Multimedia Messaging Service (MMS); Functional
             description; Stage 2".

  [209]  OMA "Multimedia Messaging Service; Encapsulation Protocol".

  [210]  OMNA WSP Content Type Numbers
             http://www.openmobilealliance.org/tech/omna/omna-wsp-content-
             type.aspx

  [211]  OMA-CP-POC: "OMA PoC Control Plane".

  [212]   Void.

  [213]  3GPP TS 29.140: "MM10 interface based on Diameter protocol; Stage
             3".

  [214]  3GPP TS 29.214: "Policy and Charging Control over Rx reference
             point; Stage 3".

  [215]  3GPP TS 29.212: "Policy and Charging Control (PCC); Reference
             points".

  [216]  3GPP TS 23.040: "Technical realization of Short Message Service
             (SMS)".

  [217]  3GPP TS 22.142: "Value Added Services (VAS) for Short Message
             Service (SMS) requirements".

  [218]  3GPP TS 23.203: "Policy and Charging control architecture".

  [219]  3GPP TS 29.272: " Mobility Management Entity (MME) and Serving
             GPRS Support Node (SGSN) related interfaces based on Diameter
             protocol".

  [220]  3GPP TS 24.605: "Conference (CONF) using IP Multimedia (IM) Core
             Network (CN) subsystem; Protocol specification".

  [221]  3GPP TS 29.329: "Sh Interface based on the Diameter
             protocol;Protocol details".

  [222]  3GPP TS 29.658: "SIP Transfer of IP Multimedia Service Tariff
             Information".

  [223]  OMA-DDS-Charging_Data: "Charging Data".

  [224]  3GPP TS 23.003: "Numbering, Addressing and Identification".

  [225]  3GPP TS 29.060: "General Packet Radio Service (GPRS); GPRS
             Tunnelling Protocol (GTP) across the Gn and Gp interface".

  [226]  3GPP TS 29.274: "Evolved GPRS Tunnelling Protocol for Control
             Plane (GTPv2-C); Stage 3".

  [227]  3GPP TS 23.032: "Universal Geographical Area Description (GAD)".

  [228]  3GPP TS 23.167: "IP Multimedia Subsystem (IMS) emergency
             sessions".

  [229]  3GPP TS 29.173: "Location Services (LCS);Diameter-based SLh
             interface for Control Plane LCS".

  [230]  3GPP TS 29.272: "Evolved Packet System (EPS);Mobility Management
             Entity (MME) and Serving GPRS Support Node (SGSN) related
             interfaces based on Diameter protocol".

  [231]  3GPP TS 29.337: "Diameter-based T4 interface for communications
             with packet data networks and applications ".

  [232]  3GPP TS 29.002: "Mobile Application Part (MAP) specification".

  [233]  3GPP TS 29.078: "Customised Applications for Mobile network
             Enhanced Logic (CAMEL); CAMEL Application Part (CAP)
             specification".

  [234]  3GPP TS 29.163: "Interworking between the IP Multimedia (IM) Core
             Network (CN) subsystem and Circuit Switched (CS) networks".

  [235]  3GPP TS 23.303: "Proximity-based services (ProSe)".

  [236]  3GPP TS 24.334: "Proximity-services (ProSe) User Equipment (UE) to
             ProSe function protocol aspects".

  [237]  3GPP TS 29.273: "Evolved Packet System (EPS); 3GPP EPS   AAA
             Interfaces".

  [238]  3GPP TS 29.343: "Proximity-services (ProSe) function to ProSe
             application server aspects (PC2)".

  [239]  3GPP TS 29.345: "Inter-Proximity-services (ProSe) Function
             signalling aspects".

  [240]  Void.

  [241]  3GPP TS 36.331: "Evolved Universal Terrestrial Radio Access (E-
             UTRA); Radio Resource Control (RRC); Protocol specification".

  [242]  Void.

  [243]  3GPP TS 23.682: "Architecture enhancements to facilitate
             communications with packet data networks and applications".

  [244]  3GPP TS 29.128: "Mobility Management Entity (MME) and Serving GPRS
             Support Node (SGSN) interfaces for interworking with packet
             data networks and applications".

  [245]  3GPP TS 29.336: "Home Subscriber Server (HSS) diameter interfaces
             for interworking with packet data networks and applications".

  [246]  3GPP TS 33.210: "3G security; Network Domain Security (NDS); IP
             network layer security ".

  [247] - [299] Void.

  [300]  ETSI TS 283 034 v2.2.0: "Telecommunications and Internet
             converged Services and Protocols for Advanced Networking
             (TISPAN); Network Attachment Sub-System (NASS); e4 interface
             based on the DIAMETER protocol".

  [301]  oneM2M TS-0004: "Service Layer Core Protocol Specification".

  [302] - [400] Void.

  [401]  IETF RFC 6733 (2012): "Diameter Base Protocol".

  [402]  IETF RFC 4006 (2005): "Diameter Credit-Control Application".

  [403]  Void.

  [404]  IETF RFC 7315 (2014): "Private Extensions to the Session
             Initiation Protocol (SIP) for the 3rd Generation Partnership
             Projects (3GPP)".

  [405]  IETF RFC 3261 (2002): "SIP: Session Initiation Protocol".

  [406]  IETF RFC 4566 (2006): "SDP: Session Description Protocol".

  [407]  IETF RFC 4005 (2005): "Diameter Network Access Server
             Application".

  [408]  IETF RFC 3264 (2002): "An Offer/Answer Model with the Session
             Description Protocol (SDP) ".

  [409]  IEEE 802.11-2012: "IEEE Standard for Information technology -
             Telecommunications and information exchange between systems -
             Local and metropolitan area networks - Specific requirements -
             Part 11: Wireless LAN Medium Access Control (MAC) and Physical
             Layer (PHY) Specifications".

  [410]  IETF RFC 3066 (2001): "Tags for the Identification of Languages".

  [411]  IETF RFC 7683 (2015):"Diameter Overload Indication Conveyance".


3  Definitions, symbols and abbreviations


3.1  Definitions

For the purposes of the present document, the terms and definitions given
in TR 21.905 [100] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
TR 21.905 [100].

middle tier TS: term used for the 3GPP charging TSs that specify the domain
/ subsystem / service specific, online and offline, charging functionality.
These are all the TSs in the numbering range from TS 32.250 to TS 32.27x,
e.g. TS 32.250 [10] for the CS domain, or TS 32.270 [30] for the MMS
service. Currently, there is only one "tier 1" TS in 3GPP, which is the TS
32.240 that specifies the charging architecture and principles. Finally,
there are a number of top tier TSs in the 32.29x numbering range ([50] ff)
that specify common charging aspects such as parameter definitions,
encoding rules, the common billing domain interface or common charging
applications.

offline charging: charging mechanism where charging information does not
affect, in real-time, the service rendered

online charging: charging mechanism where charging information can affect,
in real-time, the service rendered and therefore a direct interaction of
the charging mechanism with session/service control is required


3.2  Symbols

For the purposes of the present document, the following symbols apply:

  Rf Offline Charging Reference Point between a 3G network element and the
             CDF.
  Ro Online Charging Reference Point between a 3G network element and the
             OCS.

3.3  Abbreviations

For the purposes of the present document, the following abbreviations
apply:

  5GS  5G System
  5GC  5G Core
  ACA  ACcounting-Answer
  ACR  ACcounting-Request
  ADC  Application Detection and Control
  AoC  Advice of Charge
  AS Application Server
  ASA  Abort-Session-Answer
  ASR  Abort-Session- Request
  AVP  Attribute Value Pair
  CCA  Credit-Control-Answer
  CCR  Credit-Control-Request
  CDF  Charging Data Function
  CDR  Charging Data Record
  CEA  Capabilities-Exchange-Answer
  CER  Capabilities-Exchange-Request
  CGI  Cell Global Identification
  CI Cost-Information
  CIoT Cellular Internet of Things
  CP Control Plane
  CSG  Closed Subscriber Group
  CSG ID Closed Subscriber Group Identity
  DBPA Diameter Base Protocol Accounting
  DCD  Dynamic Content Delivery
  DPA  Disconnect-Peer-Answer
  DPR  Disconnect-Peer-Request
  DRM  Digital Rights Management
  DWA  Device-Watchdog-Answer
  DWR  Device-Watchdog-Request
  ECGI E-UTRAN Cell Global Identifier
  ECUR Event Charging with Unit Reservation
  FQDN Fully Qualified Domain Name
  FUI  Final-Unit-Indication
  HSGW HRPD Serving GateWay
  GSU  Granted-Service-Unit
  IEC  Immediate Event Charging
  IM Instant Messaging
  IMS  IP Multimedia Subsystem
  IMS-AGW  IMS Access Media Gateway
  IWK-SCEF Interworking SCEF
  MSCC Multiple Services Credit-Control
  NetLoc Network provided Location information
  NIDD Non-IP Data Delivery
  NNI  Network to Network Interface
  NR New Radio
  OCS  Online Charging System
  PFDF Packet Flow Description Function
  ProSe  Proximity-based Services
  RAA  Re-Auth-Answer
  RAI  Routeing Area Identity
  RAR  Re-Auth-Request
  RAVEL  Roaming Architecture for VoicE over IMS with Local breakout
  SAI  Service Area Identifier
  SCCP Signalling Connection Control Part
  SCEF Service Capability Exposure Function
  SCS  Services Capability Server
  SDP  Session Description Protocol
  RCAF RAN Congestion Awareness Function
  TAI  Tracking Area Identity
  TDF  Traffic Detection Function
  TLTRI  T8 Long Term Transaction Reference ID
  TrGW Transition GateWay
  TWAG Trusted WLAN Access Gateway
  TWAN Trusted WLAN Access Network
  UWAN Untrusted Wireless Access Network
  VCS  Voice Call Service

         4  Architecture considerations


4.1  High level architecture


4.1.0  General

The Rf and the Ro are reference points from the Charging Trigger Function
(CTF) to the Charging Data Function (CDF) and the Online Charging Function
(OCF) respectively, and are intended for the transport of charging events.
Rf is used for offline charging whereas Ro is used for online charging.
Figure 4.1.0.1 and figure 4.1.0.2 depict the position of the Rf and Ro
reference points within the overall 3GPP online and offline charging
architecture.

                                    [pic]

  CTF: Charging Trigger Function
  CDF: Charging Data Function
  CGF: Charging Gateway Function
  BD:  Billing Domain. This may also be a billing mediation device / post-
         processing system.


      Figure 4.1.0.1: Logical ubiquitous offline charging architecture

                                    [pic]

  CTF: Charging Trigger Function
  OCF: Online Charging Function
  CGF: Charging Gateway Function
  BD:  Billing Domain. This may also be a billing mediation device / post-
         processing system.


       Figure 4.1.0.2: Logical ubiquitous online charging architecture

Different mappings of the ubiquitous offline charging functions, CTF, CDF
and CGF, onto physical implementations are possible. Further details of the
configuration refer toTS 32.240 [1]. Details of the implementation options
per domain / subsystem / service (usually a subset of the overall possible
variants described above) are specified in the respective middle tier TSs.


4.1.1  Charging related transfer requirements

Each CTF would have CDF and OCF address list to which it can send its
charging events and/or charging requests.
The list is organized in address priority order. If the primary charging
function is not available (e.g. out of service) then the CTF shall send the
charging information to the secondary charging function and so on.

Within the scope of this release, each Network Element that generates
charging information sends the information only to the charging entities of
the same PLMN, and not to charging entities in other PLMNs.
To implement roaming unbundling for EU roaming regulation III, an
architectural solution known as the Single IMSI architecture has been
defined. In this architecture a specific Service-NE (known as a Proxy
Function) uses the Ro reference point for sending charging information to
an OCF in another network. The details of this architecture are defined in
Annex B of TS 32.240 [1].

To implement PS domain online charging for roaming context, PCEF in the
VPLMN uses the Gy reference point, and TDF in the VPLMN uses the Gyn
reference point, both based on Ro interface and specified in TS 32.251[11],
for sending charging information to an OCS in the HPLMN. A simplified
profile is provided in Annex E of TS 32.251[11] for deployment purposes.

Each CDF in the PLMN may know of other CDFs' network addresses (e.g., for
redundancy reasons, to be able to recommend another CDF address with the
Redirection Request message). This is achieved by OAM&P configuration
facilities that enables each CDF to have a configurable list of peer CDF
addresses.



         5  3GPP charging applications requirements


5.1  Offline charging scenarios


5.1.1  Basic principles


5.1.1.0  Introduction

Offline charging for both events and sessions between CTF and the CDF is
performed using the Rf reference point as defined in TS 32.240 [1].

Two basic scenarios are used:

  -  Event based charging;

  -  Session based charging.



           5.1.1.1  Event based charging

In scenario figure 5.1.1.1.1, CTF asks the CDF to store event related
charging data.

                                    [pic]

                   Figure 5.1.1.1.1: Event based charging

  1) Request for resource usage: UE-A requests the desired resource from
    the Network Element.

  2) Content/Service Delivery: the Network Element delivers the
    content/service.

  3) Charging Data Generation: the CTF generates charging data related to
    service delivery.

  4) Record Charging Data Request: the CTF requests the CDF to store event
    related charging data for CDR generation purposes.

  5) Process Request: CDF stores received information. Whether the CDR is
    generated or not depends on CDR generation configuration.

  6) Record Charging Data Response: the CDF informs the CTF that charging
    data was stored.


5.1.1.2  Session based charging

In scenario figure 5.1.1.2.1, CTF asks the CDF to store session related
charging data.

                                    [pic]

                  Figure 5.1.1.2.1: Session based charging

  1) Request for resource usage: UE-A requests the desired session from the
    Network Element.

  2) Session ongoing: the Network Element establish the session.

  3) Charging Data Generation: the CTF generates charging data related to
    session.

  4) Record Charging Data Request: the CTF requests the CDF to store
    session related charging data for CDR generation purposes.

  5) Process Request: CDF stores received information. Whether the CDR is
    generated or not depends on CDR generation configuration.

  6) Record Charging Data Response: the CDF informs the CTF that charging
    data was stored.

  7) Charging Data Generation: the CTF generates charging data related to
    session due of e.g. intermediate timer expiry.

  8) Record Charging Data Request: the CTF requests the CDF to store
    session related charging data for CDR generation purposes.

  9) Process Request: CDF stores received information. Whether the CDR is
    generated or not depends on CDR generation configuration.

  10)  Record Charging Data Response: the CDF informs the CTF that charging
    data was stored.

  11)  Session release: the session is released.

  12)  Charging Data Generation: the CTF generates charging data related to
    session due of session termination.

  13)  Record Charging Data Request: the CTF requests the CDF to store
    session related charging data for CDR generation purposes.

  14)  Process Request: CDF stores received information. Whether the CDR is
    generated or not depends on CDR generation configuration.

  15)  Record Charging Data Response: the CDF informs the CTF that charging
    data was stored.



         5.1.2  Basic operation

Event and session based Charging are performed by the use of the "Charging
Data Transfer" operation:

  -  "Charging Data Request"; sent from CTF ( CDF
    After detecting a chargeable event, the CTF sends a Charging Data
    Request to the CDF.

  -  "Charging Data Response"; sent from CDF ( CTF
    The CDF replies with a Charging Data Response, which informs the CTF
    that charging data was received.

Table 5.1.2.1 and table 5.1.2.2 describe the content of these operations.

                Table 5.1.2.1: Charging Data Request content

|Information Element     |Catego|Description                                |
|                        |ry    |                                           |
|Session Identifier      |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Originator Host         |M     |This field contains the identification of  |
|                        |      |the source point of the operation and the  |
|                        |      |realm of the operation originator.         |
|Originator Domain       |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Destination Domain      |M     |This field contains the realm of the       |
|                        |      |operation destination.                     |
|Operation Type          |M     |This field defines the transfer type: event|
|                        |      |for event based charging and start,        |
|                        |      |interim, stop for session based charging.  |
|Operation Number        |M     |This field contains the sequence number of |
|                        |      |the transferred messages.                  |
|Operation Identifier    |OM    |The field corresponds to the unique        |
|                        |      |operation identification.                  |
|User Name               |OC    |The field contains the identification of   |
|                        |      |the service user.                          |
|Destination Host        |OC    |This field contains the identification of  |
|                        |      |the destination point of the operation.    |
|Operation Interval      |OC    |This field contains the proposal for       |
|                        |      |instructions to produce records            |
|                        |      |continuously during a session.             |
|Origination State       |OC    |This field contains the state associated to|
|                        |      |the source point of the operation.         |
|Origination Timestamp   |OC    |This field contains the time when the      |
|                        |      |operation is requested.                    |
|Proxy Information       |OC    |This field contains the parameter of the   |
|                        |      |proxy.                                     |
|Route Information       |OC    |This field contains the parameter of the   |
|                        |      |route.                                     |
|Operation Token         |OM    |This field identifies the domain, subsystem|
|                        |      |or service and release.                    |
|Service information     |OM    |This parameter holds the individual service|
|                        |      |specific parameters as defined in the      |
|                        |      |corresponding 'middle tier' TS.            |


                Table 5.1.2.2: Charging Data Response content

|Information Element     |Catego|Description                                |
|                        |ry    |                                           |
|Session Identifier      |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Operation Result        |M     |This field identifies the result of the    |
|                        |      |operation.                                 |
|Originator Host         |M     |This field contains the identification of  |
|                        |      |the source point of the operation and the  |
|                        |      |realm of the operation originator.         |
|Originator Domain       |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Operation Type          |M     |This field defines the transfer type: event|
|                        |      |for event based charging and start,        |
|                        |      |interim, stop for session based charging.  |
|Operation Number        |M     |This field contains the sequence number of |
|                        |      |the transferred messages.                  |
|Operation Identifier    |OM    |The field corresponds to the unique        |
|                        |      |operation identification.                  |
|Operation Interval      |OC    |This field contains the instructions to    |
|                        |      |produce records continuously during a      |
|                        |      |session.                                   |
|Error Reporting Host    |OC    |If proxies exist between the accounting    |
|                        |      |client and the accounting server this field|
|                        |      |contains the identity of the proxy that    |
|                        |      |sent a response other than 2001 (Success). |
|Origination State       |OC    |This field contains the state associated to|
|                        |      |the source point of the service.           |
|Origination Timestamp   |OC    |This field contains the time when the      |
|                        |      |operation is requested.                    |
|Proxy Information       |OC    |This field contains the parameter of the   |
|                        |      |proxy.                                     |




         5.2  Online charging scenarios


5.2.0  Introduction

Online charging for both events and sessions between CTF and the OCF is
performed using the Ro reference point. The Ro reference point supports
integrity protection and authentication for the case that the CTF is
outside the operator domain.


5.2.1  Basic principles

There are two sub-functions for online charging that affect online charging
principles and require a more detailed description: rating and unit
determination. Both rating and unit determination can be implemented
centralized, i.e. on the OCF, or decentralized, that is, on the CTF.

Unit determination refers to the calculation of the number of non-monetary
units (service units, data volume, time and events) that shall be assigned
prior to starting service delivery.

  -  With Centralized Unit Determination, the OCF determines the number of
    non-monetary units that a certain service user can consume based on a
    service key received from the CTF.

  -  With the Decentralized Unit Determination approach, the CTF determines
    itself how many units are required to start service delivery, and
    requests these units from the OCF.

After checking the service user's account balance, the OCF returns the
number of granted units to the CTF. The CTF is then responsible for the
supervision of service delivery. Particularly, the CTF shall limit service
delivery to the corresponding number of granted units.

Rating refers to the calculation of a price out of the non-monetary units
calculated by the unit determination function.

  -  With the Centralized Rating approach, the CTF and the OCF exchange
    information about non-monetary units. The OCF translates these units
    into monetary units.

  -  With the Decentralized Rating approach, the corresponding rating
    control is performed within the CTF. Consequently, CTF and OCF exchange
    information about monetary units.

Three cases for online charging can be distinguished: Immediate Event
Charging (IEC), Event Charging with Unit Reservation (ECUR) and Session
Charging with Unit Reservation (SCUR). These cases are further described in
TS 32.240 [1].



         5.2.2  Charging scenarios


5.2.2.0  Introduction

In order to perform event charging via Ro, the scenarios between the
involved entities UE-A, OCF and CTF need to be defined. The charging flows
shown in this subclause include scenarios with immediate event charging and
event charging with reservation. In particular, the following cases are
shown:

  1  Immediate Event Charging

    a) Decentralized Unit Determination and Centralized Rating

    b) Centralized Unit Determination and Centralized Rating

    c) Decentralized Unit Determination and Decentralized Rating



  2  Event charging with Unit Reservation

    a) Decentralized Unit Determination and Centralized Rating

    b) Centralized Unit Determination and Centralized Rating

    c) Decentralized Unit Determination and Decentralized Rating


  3  Session charging with Unit Reservation

    a) Decentralized Unit Determination and Centralized Rating

    b) Centralized Unit Determination and Centralized Rating

    c) Decentralized Unit Determination and Decentralized Rating



The combination of Centralized Unit Determination with Decentralized Rating
is not possible.


5.2.2.1  Immediate Event Charging (IEC)


5.2.2.1.1   Decentralized Unit Determination and Centralized Rating

In scenario figure 5.2.2.1.1.1, CTF asks the OCF to assign a defined number
of units.



                                    [pic]

     Figure 5.2.2.1.1.1: IEC - Centralized Rating and Decentralized Unit
                                Determination

  1) Request for resource usage: UE-A requests the desired resource from
    the Network Element.

  2) Units Determination: depending on the requested service the CTF
    determines the number of units accordingly.

  3) Debit Units Request: the CTF requests the OCF to assign the defined
    number of units.

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represents the price for the number of
    units determined in item 2.

  5) Account Control: provided that the user's credit balance is
    sufficient, the OCF triggers the deduction of the calculated amount
    from the subscriber's account.

  6) Debit Units Response: the OCF informs the CTF of the number of granted
    units.

  7) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the number of granted units.

  8) Credit Unit Control (cont.): this function block is optional and a
    replication of items 2 to 6.

  9) Content/Service Delivery (cont.): the continuation of content delivery
    occurs in correspondence with the occurrence of item 8.

  10)  Session released: Session is released.



             5.2.2.1.2   Centralized Unit Determination and Centralized
             Rating

In scenario figure 5.2.2.1.2.1, CTF asks the OCF to assign units based on
the service key specified by the CTF.

                                    [pic]

      Figure 5.2.2.1.2.1: IEC - Centralized Rating and Centralized Unit
                                Determination

  1) Request for resource usage: The UE-A requests the desired resource or
    content from the Network Element.

  2) Debit Units Request: depending on the service requested by the UE-A,
    the CTF determines the service key and forwards the Debit Units Request
    with service key to the OCF.

  3) Units Determination: the OCF determines the number of non-monetary
    units needed for the content/service delivery, based on the received
    service key.

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represent the price for the number of
    units determined in item 3.

  5) Account Control: provided that the user's credit balance is
    sufficient, the OCF triggers the deduction of the calculated amount
    from the subscriber's account.

  6) Debit Units Response: the OCF informs the CTF of the number of granted
    units. This includes the case where the number of units granted
    indicates the permission to render the service that was identified by
    the received service key.

  7) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the number of granted units.

  8) Credit Service Control (cont.): this function block is optional and a
    replication of items 2 to 6.

  9) Content/Service Delivery (cont.): the continuation of content delivery
    occurs in correspondence with the occurrence of item 8.

  10)  Session released: the session is released.



             5.2.2.1.3   Decentralized Unit Determination and Decentralized
             Rating

In  scenario figure 5.2.2.1.3.1, the CTF asks the OCF to assure the
deduction of an amount of the specified number of monetary units from the
subscriber's account.

                                    [pic]

    Figure 5.2.2.1.3.1: IEC - Decentralized Rating and Decentralized Unit
                                Determination

  1) Request for resource usage: The UE-A requests the desired content from
    the Network Element.

  2) Units Determination: depending on the service requested by the UE-A,
    the CTF determines the number of units accordingly.

  3) Rating Control: the CTF calculates the number of monetary units that
    represent the price for the number of units determined in item 2.

  4) Debit Units Request: the CTF requests the OCF to assure the deduction
    of an amount corresponding to the calculated number of monetary units
    from the subscriber's account.

  5) Account Control: provided that the user's credit balance is
    sufficient, the OCF triggers the deduction of the calculated amount
    from the subscriber's account.

  6) Debit Units Response: the OCF indicates to the CTF the number of
    deducted monetary units.

  7) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the number of units as specified in items 2 and 3.

  8) Credit Amount Control (cont.): this function block is optional and a
    replication of items 2 to 6.

  9) Content/Service Delivery (cont.): the continuation of content delivery
    occurs in correspondence with the occurrence of item 8.

  10)  Session released: the session is released.


5.2.2.1.4   Further options

In addition to the flows that are specified in the previous subclauses, the
Debit Unit operation may alternatively be carried out concurrently with
service delivery, or after completion of service delivery.



           5.2.2.2  Event Charging with Unit Reservation (ECUR)


5.2.2.2.1   Decentralized Unit Determination and Centralized Rating

In scenario figure 5.2.2.2.1.1, the CTF requests the reservation of units
prior to service delivery.
An account debit operation is carried out following the conclusion of
service delivery.

                                    [pic]

      Figure 5.2.2.2.1.1: ECUR -  Decentralized Unit Determination and
                             Centralized Rating

  1) Request for resource usage: The UE-A requests the desired
    content/service from the NE.

  2) Units Determination: depending on the requested service the CTF
    determines the number of units accordingly.

  3) Reserve Units Request: the CTF requests the OCF to reserve the number
    of units determined in item 2.

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represents the price for the number of
    units determined in item 2.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's account balance is sufficient then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of units.

  8) Reserved Units Supervision: simultaneously with the service delivery,
    the CTF monitors the consumption of the reserved units.

  9) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the reserved number of units.

  10)  Debit Units Request: the CTF requests the OCF to assure the
    deduction of an amount corresponding to the consumed number of units
    from the subscriber's account. In the case that no further units are
    required for this service, an appropriate indication triggering the
    release of the remaining reservation is given.

  11)  Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units to deduct from the subscriber's account.

  12)  Account Control: the OCF triggers the deduction of the calculated
    amount from the subscriber's account.

  13)  Debit Units Response: the OCF informs the CTF of the actually
    deducted units.

  14)  Session Release: the session is released.



             5.2.2.2.2   Centralized Unit Determination and Centralized
             Rating

In scenario figure 5.2.2.2.2.1, the CTF requests the OCF to reserve units
based on the service key specified by the CTF. An account debit operation
is carried out following the conclusion of service delivery.

                                    [pic]

  Figure 5.2.2.2.2.1: ECUR - Centralized Unit Determination and Centralized
                                   Rating

  1) Request for resource usage: The UE-A requests the desired content from
    the CTF.

  2) Reserve Units Request: depending on the service requested by the UE-A,
    the CTF determines the service key and forwards the Reserve Units
    Request with service key to the OCF.

  3) Units Determination: the OCF determines the number of non-monetary
    units needed for the content/service delivery, based on the received
    service key.

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represent the price for the number of
    units determined in item 3.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's account balance is sufficient, then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of units. This includes the case where the number of units reserved
    indicates the permission to render the service that was identified by
    the received service key.

  8) Granted Units Supervision: simultaneously with the service delivery,
    the CTF monitors the consumption of the reserved units.

  9) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the reserved number of units.

  10)  Debit Units Request: the CTF provides according to previous Reserve
    Units Response the request to deduct the amount of units corresponding
    to the consumed number of units.

  11)  Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units to deduct from the subscriber's account.

  12)  Account Control: the OCF triggers the deduction of the calculated
    amount from the subscriber's account.

  13)  Debit Units Response: the OCF informs the CTF of the actually
    deducted units.

  14)  Session Released: the session is released.



             5.2.2.2.3   Decentralized Unit Determination and Decentralized
             Rating

In scenario figure 5.2.2.2.3.1, the CTF request the OCF to assure the
reservation of an amount of the specified number of monetary units from the
subscriber's account. An account debit operation that triggers the
deduction the amount from the subscriber's account is carried out following
the conclusion of service delivery.

                                    [pic]

  Figure 5.2.2.2.3.1: ECUR - Centralized Unit Determination and Centralized
                                   Rating

  1) Request for resource usage: The UE-A requests the desired content from
    the CTF.

  2) Units Determination: depending on the service requested by the UE-A,
    the CTF determines the number of units accordingly.

  3) Rating Control: the CTF calculates the number of monetary units that
    represent the price for the number of units determined in item 2.

  4) Reserve Units Request: the CTF requests the OCF to assure the
    reservation of an amount corresponding to the calculated number of
    monetary units from the subscriber's account.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's credit balance is sufficient, then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of monetary units.

  8) Budget Control: simultaneously with the service delivery, the CTF
    monitors the consumption of the granted amount.

  9) Content/Service Delivery: the CTF delivers the content/service at
    once, in fractions or in individually chargeable items, corresponding
    to the number of units.

  10)  Debit Units Request: the CTF requests the OCF to assure the
    deduction of an amount corresponding to the consumed number of monetary
    units from the subscriber's account.

  11)  Account Control: the OCF triggers the deduction of the consumed
    amount from the subscriber's account.

  12)  Debit Units Response: the OCF indicates to the CTF the number of
    deducted monetary units.

  13)  Session Released: the session is released.



           5.2.2.3  Session charging with Reservation


5.2.2.3.1   Decentralized Unit Determination and Centralized Rating

In scenario figure 5.2.2.3.1.1, the CTF requests the reservation of units
prior to session supervision. An account debit operation is carried out
following the conclusion of session termination.

                                    [pic]

 Figure 5.2.2.3.1.1: SCUR - Decentralized Unit Determination and Centralized
                                   Rating

  1) Request for resource usage: The UE-A requests session establishment
    from the CTF.

  2) Units Determination: depending on the requested type of the session
    the CTF determines the number of units accordingly.

  3) Reserve Units Request: the CTF requests the OCF to reserve the number
    of units determined in item 2

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represents the price for the number of
    units determined in item 2.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's account balance is sufficient then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of units.

  8) Reserved Units Supervision: simultaneously with the ongoing session,
    the CTF monitors the consumption of the reserved units.

  9) Session ongoing: the CTF maintains the session. One or more debit and
    reserve operations may be performed when the session is ongoing.

  10)  Session Release: the session is released

  11)  Debit Units Request: the CTF requests the OCF to assure the
    deduction of an amount corresponding to the consumed number of units
    from the subscriber's account.

  12)  Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units to deduct from the subscriber's account.

  13)  Account Control: the OCF triggers the deduction of the calculated
    amount from the subscriber's account.

  14)  Debit Units Response: the OCF informs the CTF of the actually
    deducted units.



             5.2.2.3.2   Centralized Unit Determination and Centralized
             Rating

In scenario figure 5.2.2.3.2.1, the CTF requests the OCF to reserve units
based on the service key specified by the CTF. An account debit operation
is carried out following the conclusion of session.

                                    [pic]

  Figure 5.2.2.3.2.1: SCUR - Centralized Unit Determination and Centralized
                                   Rating


  1) Request for resource usage: The UE-A requests the session
    establishment from the CTF.

  2) Reserve Units Request: depending on the requested type of the session
    by the UE-A, the CTF determines the service key identifier and forwards
    the Reserve Un with service key its Request to the OCF.

  3) Units Determination: the OCF determines the number of non-monetary
    units needed for the content/service delivery, based on the received
    service key.

  4) Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units that represent the price for the number of
    units determined in item 3.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's account balance is sufficient, then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of units. This includes the case where the number of units reserved
    indicates the permission to render the service that was identified by
    the received service key.

  8) Granted Units Supervision: simultaneously with the ongoing session,
    the CTF monitors the consumption of the reserved units.

  9) Session ongoing: the CTF maintains the session. One or more debit and
    reserve operations may be performed when the session is ongoing.

  10)  Session Released: the session is released.

  11)  Debit Units Request: the CTF requests the OCF to assure the
    deduction of an amount corresponding to the consumed number of units
    from the subscriber's account

  12)  Rating Control: assisted by the rating entity the OCF calculates the
    number of monetary units to deduct from the subscriber's account.

  13)  Account Control: the OCF triggers the deduction of the calculated
    amount from the subscriber's account.

  14)  Debit Units Response: the OCF informs the CTF of the actually
    deducted units.



             5.2.2.3.3   Decentralized Unit Determination and Decentralized
             Rating

In scenario figure 5.2.2.3.3.1, the CTF request the OCF to assure the
reservation of an amount of the specified number of monetary units from the
subscriber's account. An account debit operation that triggers the
deduction the amount from the subscriber's account is carried out following
the conclusion of session establishment.

                                    [pic]

       Figure 5.2.2.3.3.1: SCUR - Decentralized Unit Determination and
                            Decentralized Rating

  1) Request for resource usage: The UE-A requests the session
    establishment from the CTF.

  2) Units Determination: depending on the requested type of the session by
    the UE-A, the CTF determines the number of units accordingly.

  3) Rating Control: the CTF calculates the number of monetary units that
    represent the price for the number of units determined in item 2.

  4) Reserve Units Request: the CTF requests the OCF to assure the
    reservation of an amount corresponding to the calculated number of
    monetary units from the subscriber's account.

  5) Account Control: the OCF checks whether the user's account balance is
    sufficient for the requested reservation.

  6) Reservation Control: if the user's credit balance is sufficient, then
    the corresponding reservation is made.

  7) Reserve Units Response: the OCF informs the CTF of the reserved number
    of monetary units.

  8) Budget Control: simultaneously with the ongoing session, the CTF
    monitors the consumption of the granted amount.

  9) Session ongoing: the CTF maintains the session. One or more debit and
    reserve operations may be performed when the session is ongoing.

  10)  Session Released: the session is released.

  11)  Debit Units Request: the CTF requests the OCF to assure the
    deduction of an amount corresponding to the consumed number of monetary
    units from the subscriber's account.

  12)  Account Control: the OCF triggers the deduction of the consumed
    amount from the subscriber's account.

  13)  Debit Units Response: the OCF indicates to the CTF the number of
    deducted monetary units.



         5.2.3  Basic operations

Online Credit-Control uses two basic logical operations: Debit Units and
Reserve Units.

  -  "Debit Units Request"; sent from CTF ( OCF
    After receiving a service request from the subscriber, the CTF sends a
    Debit Units Request to the OCF.
    The CTF may either specify a service key (centralised unit
    determination) or the number of units requested (decentralised unit
    determination).
    For refund purpose, the CTF sends a Debit Units Request to the OCF as
    well.

  -  "Debit Units Response"; sent from OCF ( CTF
    The OCF replies with a Debit Units Response, which informs the CTF of
    the number of units granted as a result of the Debit Units Request.
    This includes the case where the number of units granted indicates the
    permission to render the requested service.
    For refund purpose, the OCF replies with a Debit Units Response.

  -  "Reserve Units Request"; sent from CTF ( OCF
    Request to reserve a number of units for the service to be provided by
    an CTF. In case of centralized unit determination, the CTF specifies a
    service key in the Reserve Unit Request, and the OCF determines the
    number of units requested. In case of decentralised unit determination,
    the number of units requested is specified by the CTF.

  -  "Reserve Units Response"; sent from OCF ( CTF
    Response from the OCF which informs the CTF of the number of units that
    were reserved as a result of the "Reserve Units Request".

IEC uses the Direct Debiting One Time Event procedure specified in RFC 4006
[402] and therefore is performed by the use of the logical "Debit Units"
operation, as specified in clause 6.3.3.

SCUR and ECUR use both the "Debit Units" and "Reserve Units" operations.

SCUR uses the Session Based Credit-Control procedure specified in RFC 4006
[402]. In session charging with unit reservation, when the "Debit Units"
and "Reserve Units" operations are both needed, they shall be combined in
one message, as specified in clause 6.3.5.

For SCUR and ECUR the consumed units are deducted from the subscriber's
account after service delivery.
Thus, the reserved and consumed units are not necessarily the same. Using
this operation, it is also possible for the CTF to modify the current
reservation, including the return of previously reserved units.

Table 5.2.3.1 and table 5.2.3.2 describe the content of these operations.



            Table 5.2.3.1: Debit / Reserve Units Request content

|Information  |Catego|Description                                           |
|Element      |ry    |                                                      |
|Session      |M     |This field identifies the operation session.          |
|Identifier   |      |                                                      |
|Originator   |M     |This field contains the identification of the source  |
|Host         |      |point of the operation.                               |
|Originator   |M     |This field contains the realm of the operation        |
|Domain       |      |originator.                                           |
|Destination  |M     |This field contains the realm of the operation        |
|Domain       |      |destination.                                          |
|Operation    |M     |This field is a unique operation identifier.          |
|Identifier   |      |                                                      |
|Operation    |M     |This field contains the service identifier.           |
|Token        |      |                                                      |
|Operation    |M     |This field defines the transfer type: event for event |
|Type         |      |based charging and start, interim, stop for session   |
|             |      |based charging.                                       |
|Operation    |M     |This field contains the sequence number of the        |
|Number       |      |transferred messages.                                 |
|Destination  |OC    |This field contains the identification of the         |
|Host         |      |destination point of the operation.                   |
|User Name    |OC    |This field contains the identification of the user.   |
|Origination  |OC    |This field contains the state associated to the source|
|State        |      |point of the operation.                               |
|Origination  |OC    |This field contains the time when the operation is    |
|Timestamp    |      |requested.                                            |
|Subscriber   |OM    |This field contains the identification of the mobile  |
|Identifier   |      |subscriber (i.e. MSISDN) or the fixed user (i.e. fixed|
|             |      |device or residential gateway ) that uses the         |
|             |      |requested service.                                    |
|Termination  |OC    |This field contains the termination reason of the     |
|Cause        |      |service.                                              |
|Requested    |OC    |This field contains the requested action.             |
|Action       |      |                                                      |
|AoC Type     |OC    |This field denotes if AoC Information is requested and|
|             |      |what type of information is needed.                   |
|Multiple     |OM    |This field indicate the occurrence of multiple        |
|Operation    |      |operations.                                           |
|Multiple Unit|OC    |This field contains the parameter for the quota       |
|Operation    |      |management.                                           |
|Operation    |OC    |This field contains information to correlate messages |
|Correlation  |      |generated for different components of the service.    |
|Identifier   |      |                                                      |
|Subscriber   |OC    |This field contains the identification of the mobile  |
|Equipment    |      |device (i.e. IMEI) that uses the subscriber.          |
|Number       |      |                                                      |
|Proxy        |OC    |This field contains the parameter of the proxy.       |
|Information  |      |                                                      |
|Route        |OC    |This field contains the parameter of the route.       |
|Information  |      |                                                      |
|Service      |OM    |This parameter holds the individual service specific  |
|Information  |      |parameters as defined in the corresponding 'middle    |
|             |      |tier' TS.                                             |


            Table 5.2.3.2: Debit / Reserve Units Response content

|Information Element     |Catego|Description                                |
|                        |ry    |                                           |
|Session Identifier      |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Operation Result        |M     |This field identifies the result of the    |
|                        |      |operation.                                 |
|Originator Host         |M     |This field contains the identification of  |
|                        |      |the source point of the operation.         |
|Originator Domain       |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Operation Identifier    |M     |This field is a unique operation           |
|                        |      |identifier.                                |
|Operation Type          |M     |This field defines the transfer type: event|
|                        |      |for event based charging and start,        |
|                        |      |interim, stop for session based charging.  |
|Operation Number        |M     |This field contains the sequence number of |
|                        |      |the transferred messages.                  |
|Operation Failover      |OC    |This field contains an indication to the   |
|                        |      |CTF whether or not a failover handling is  |
|                        |      |to be used when necessary.                 |
|Multiple Unit Operation |OC    |This field contains the parameter for the  |
|                        |      |quota management.                          |
|Cost Information        |OC    |This field contains the cost information of|
|                        |      |the service.                               |
|Low Balance Indication  |OC    |This field indicates whether the subscriber|
|                        |      |account balance went below a designated    |
|                        |      |threshold set by his account.              |
|Remaining Balance       |OC    |This field contains the remaining balance  |
|                        |      |of the subscriber.                         |
|Operation Failure Action|OC    |For Credit-Control sessions the content of |
|                        |      |this field enables the credit-control      |
|                        |      |client to decide what to do if sending     |
|                        |      |credit-control messages to the             |
|                        |      |credit-control server has been temporarily |
|                        |      |prevented.                                 |
|Operation Event Failure |OC    |For one time event direct debiting the     |
|Action                  |      |content of this field enables the          |
|                        |      |credit-control client to decide what to do |
|                        |      |if sending credit-control messages to the  |
|                        |      |credit-control server has been temporarily |
|                        |      |prevented.                                 |
|Redirection Host        |OC    |This field contains the host the request   |
|                        |      |should be forwarded to.                    |
|Redirection Host Usage  |OC    |This field identifies the routing entry    |
|                        |      |resulting from the Redirect-Host is to be  |
|                        |      |used.                                      |
|Redirection Cache Time  |OC    |This field contains the maximum number of  |
|                        |      |seconds the peer and route table entries,  |
|                        |      |created as a result of the Redirect-Host,  |
|                        |      |will be cached.                            |
|Proxy Information       |OC    |This field contains the parameter of the   |
|                        |      |proxy.                                     |
|Route Information       |OC    |This field contains the parameter of the   |
|                        |      |route.                                     |
|Failed parameter        |OC    |This field contains missing and/or         |
|                        |      |unsupported parameter that caused the      |
|                        |      |failure.                                   |
|Service Information     |OC    |This parameter holds the individual service|
|                        |      |specific parameters as defined in the      |
|                        |      |corresponding 'middle tier' TS.            |




         5.3  Other requirements


5.3.1  Re-authorization

The server may specify an idle timeout associated with a granted quota.
Alternatively, the client may have a configurable default value. The expiry
of that timer shall trigger a re-authorization request.

Mid-session service events (re-authorization triggers) may affect the
rating of the current service usage.
The server may instruct the Credit-Control client to re-authorize the quota
upon a number of different session related triggers that can affect the
rating conditions.

When a re-authorization is trigger, the client shall reports quota usage.
The reason for the quota being reported shall be notified to the server.


5.3.2  Threshold based re-authorization triggers

The server may optionally include an indication to the client of the
remaining quota threshold that shall trigger a quota re-authorization.


5.3.3  Termination action

The server may specify to the client the behaviour on consumption of the
final granted units, or zero units granted in the first place; this is
known as termination action.


5.3.4  Account expiration

The server may provide to the client the date and time of account
expiration, which the client may use depending on operator policy.



         6  3GPP charging applications – Protocol aspects


6.1  Basic principles for Diameter offline charging


6.1.0  Introduction

In order to support the offline charging principles described in the
present document, the Diameter client and server shall implement at least
the following Diameter options listed in RFC 6733 [401], i.e. the basic
functionality of Diameter accounting, as defined by the Diameter Base
Protocol (RFC 6733 [401]) is re-used.

The charging architecture implementing Diameter adheres to the structure
where all communications for offline charging purposes between the CTF
(Diameter client) and the CDF (Diameter server) are carried out on the
Diameter Rf reference point, where the CTF reports charging information to
the Charging Data Function (CDF). The CDF uses this information to
construct and format CDRs. The above-mentioned reference points are defined
in TS 32.240 [1].

A configurable timer is supported in the CDF to supervise the reception of
the ACR[Interim] and/or ACR[Stop]. An instance of the "Timer" is started at
the beginning of the accounting session, reset on the receipt of an
ACR[Interim] and stopped at the reception of the ACR[Stop]. Upon expiration
of the timer, the CDF stops the accounting session with the appropriate
error indication.

For offline charging, the CTF implements the accounting state machine
described in RFC 6733 [401].
The server (CDF) implements the accounting state machine "SERVER, STATELESS
ACCOUNTING" as specified in RFC 6733 [401], i.e. there is no order in which
the server expects to receive the accounting information.

The offline charging functionality is based on the Network Elements
reporting accounting information upon reception of various messages which
trigger charging generation, as most of the accounting relevant information
is contained in these messages. This reporting is achieved by sending
Diameter Accounting Requests (ACR) [start, interim, stop and event] from
the Network Elements to the CDF.

Following the Diameter base protocol specification, the following "types"
of accounting data may be sent with regard to offline charging:

 1. START session accounting data.

 2. INTERIM session accounting data.

 3. STOP session accounting data.

 4. EVENT accounting data.

Two cases are currently distinguished for offline charging purposes:

 5. Event based charging; and

 6. Session based charging.

ACR types START, INTERIM and STOP are used for accounting data related to
successful sessions. In contrast, EVENT accounting data is unrelated to
sessions, and is used e.g. for a simple registration or interrogation and
successful service event triggered by a Network Element. In addition, EVENT
accounting data is also used for unsuccessful session establishment
attempts.

The flows and scenarios for the above two described cases are further
detailed below.


6.1.1  Event based charging

In the case of event based charging, the network reports the usage or the
service rendered where the service offering is rendered in a single
operation. It is reported using the ACR[Event].

Figure 6.1.1.1 shows the transactions that are required on the Diameter
offline interface in order to perform event based charging. The operation
may alternatively be carried out prior to, concurrently with or after
service/content delivery.

                                    [pic]

                Figure 6.1.1.1: Event based offline charging

  Step 1:  The Network Element receives indication that service has been
       used/delivered.

  Step 2:  The Network Element (acting as client) sends Accounting-Request
       (ACR) with Accounting-Record-Type AVP set to EVENT_RECORD to indicate
       service specific information to the CDF (acting as server).

  Step 3:  The CDF receives the relevant service charging parameters and
       processes accounting request.

  Step 4:  The CDF returns Accounting-Answer message with Accounting-Record-
       Type AVP set to EVENT_RECORD to the Network Element in order to
       inform that charging information was received.


6.1.2  Session based charging

Session based charging is the process of reporting usage reports for a
session and uses the START, INTERIM and STOP accounting data. During a
session, a Network Element may transmit multiple ACR Interims' depending on
the proceeding of the session.

Figure 6.1.2.1 shows the transactions that are required on the Diameter
offline interface in order to perform session based charging.

                                    [pic]

               Figure 6.1.2.1: Session based offline charging

  Step 1:  The Network Element receives a service request. The service
       request may be initiated either by the user or the other Network
       Element.

  Step 2:  In order to start accounting session, the Network Element sends
       a Accounting-Request (ACR) with Accounting-Record-Type AVP set to
       START_RECORD to the CDF.

  Step 3:  The CDF opens a CDR for current session.

  Step 4:  The CDF returns Accounting-Answer (ACA) message with Accounting-
       Record-Type set to START_RECORD to the Network Element and possibly
       Acct-Interim-Interval AVP (AII) set to non-zero value indicating the
       desired intermediate charging interval.

  Step 5:  When either AII elapses or charging conditions changes are
       recognized at Network Element (NE), the NE sends an Accounting-
       Request (ACR) with Accounting-Record-Type AVP set to INTERIM_RECORD
       to the CDF.

  Step 6:  The CDF updates the CDR in question.

  Step 7:  The  CDF returns Accounting-Answer (ACA) message with Accounting-
       Record-Type set to INTERIM_RECORD to the Network Element.

  Step 8:  The service is terminated.

  Step 9:  The Network Element sends a Accounting-Request (ACR) with
       Accounting-Record-Type AVP set to STOP_RECORD to the CDF.

  Step 10: The CDF updates the CDR accordingly and closes the CDR.

  Step 11: The CDF returns Accounting-Answer (ACA) message with Accounting-
         Record-Type set to STOP_RECORD to the Network Element.



         6.1.3  Offline charging error cases - Diameter procedures


6.1.3.1  CDF connection failure

When the connection towards the primary CDF is broken, the process of
sending accounting information should continue towards a secondary CDF (if
such a CDF is configured). For further CDF connection failure
functionality, see clause "Transport Failure Detection" in the RFC 6733
[401].

If no CDF is reachable the Network Element may buffer the generated
accounting data in non-volatile memory. Once the CDF connection is working
again, all accounting messages stored in the buffer is sent to the CDF, in
the order they were stored in the buffer.


6.1.3.2  No reply from CDF

In case a Network Element does not receive an ACA in response to an ACR, it
may retransmit the ACR message. The waiting time until a retransmission is
sent, and the maximum number of repetitions are both configurable by the
operator. When the maximum number of retransmissions is reached and still
no ACA reply has been received, the Network Element executes the CDF
connection failure procedure as specified above.

If retransmitted ACRs' are sent, they are marked with the T-flag as
described in RFC 6733 [401], in order to allow duplicate detection in the
CDF, as specified in the next clause 6.1.3.3.


6.1.3.3  Duplicate detection

A Diameter client marks possible duplicate request messages (e.g.
retransmission due to the link fail over process) with the T-flag as
described in RFC 6733 [401].

If the CDF receives a message that is marked as retransmitted and this
message was already received, then it discards the duplicate message.
However, if the original of the re-transmitted message was not yet
received, it is the information in the marked message that is taken into
account when generating the CDR. The CDRs are marked if information from
duplicated message(s) is used.


6.1.3.4  CDF detected failure

The CDF closes a CDR when it detects that expected Diameter ACRs for a
particular session have not been received for a period of time. The exact
behaviour of the CDF is operator configurable.



         6.2  Message contents for offline charging


6.2.1  Summary of offline charging message formats


6.2.1.1  General

The corresponding Diameter accounting application messages for the Charging
Data Transfer operation is Accounting-Request (ACR) and Accounting-Answer
(ACA) as specified in the Diameter Base Protocol Accounting (DBPA)
application in RFC 6733 [401].

Table 6.2.1.1.1 describes the use of these messages which are adapted for
3GPP offline charging.

         Table 6.2.1.1.1: Offline charging messages reference table

|Command-Name       |Sour|Destina|Abbrevia|
|                   |ce  |tion   |tion    |
|Accounting-Request |CTF |CDF    |ACR     |
|Accounting-Answer  |CDF |CTF    |ACA     |
|Capabilities-Exchan|CTF |CDF    |CER     |
|ge-Request         |    |       |        |
|Capabilities-Exchan|CDF |CTF    |CEA     |
|ge-Answer          |    |       |        |


Additional Diameter messages (i.e. DPR/DPA, DWR/DWA)are used according to
the Diameter Base Protocol Accounting (DBPA) specification in RFC 6733
[401].


6.2.1.2  Structure for the Accounting message formats

The following is the basic structure shared by all offline charging
messages. This is based directly on the format of the messages defined in
the Diameter Base Protocol Application specification in RFC 6733 [401].

Those Diameter Accounting AVPs that are used for 3GPP offline charging are
marked in table 6.2.2.1 and table 6.2.3.1 with a category as specified in
TS 32.240 [1].

An AVP in grey strikethrough in the message format (in grey in the tables)
is not used by 3GPP.

The following symbols are used in the message format definition:

  -  <AVP> indicates a mandatory AVP with a fixed position in the message.

  -  {AVP} indicates a mandatory AVP in the message.

  -  [AVP] indicates an optional AVP in the message.

  -  *AVP indicates that multiple occurrences of an AVP is possible.



         6.2.2  Accounting-Request message

The ACR messages, indicated by the Command-Code field set to 271 is sent by
the CTF to the CDF in order to send charging information for the requested
bearer / subsystem /service.

The ACR message format is defined according to the Diameter Base Protocol
in RFC 6733 [401] as follows:

      <ACR> ::= < Diameter Header: 271, REQ, PXY >

                < Session-Id >
                { Origin-Host }
                { Origin-Realm }
                { Destination-Realm }
                { Accounting-Record-Type }
                { Accounting-Record-Number }
                [ Acct-Application-Id ]
                [ Vendor-Specific-Application-Id ]
                [ User-Name ]
         [ Destination-Host ]
                [ Accounting-Sub-Session-Id ]
                [ Acct-Session-Id ]
                [ Acct-Multi-Session-Id ]
                [ Acct-Interim-Interval ]
                [ Accounting-Realtime-Required ]
                [ Origin-State-Id ]
                [ Event-Timestamp ]
              * [ Proxy-Info ]
              * [ Route-Record ]
                [ Service-Context-Id ]
                [ Service-Information ]
              * [ AVP ]

  NOTE:  Similar information as in subscription_id should be added as 3GPP
         parameter, IMEI.


Table 6.2.2.1 illustrates the basic structure of a 3GPP Diameter Accounting-
Request message as used for 3GPP offline charging.

           Table 6.2.2.1: 3GPP Accounting-Request message contents

|AVP                     |Catego|Description                                |
|                        |ry    |                                           |
|Session-Id              |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Origin-Host             |M     |This field contains the identification of  |
|                        |      |the source point of the operation and the  |
|                        |      |realm of the operation originator.         |
|Origin-Realm            |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Destination-Realm       |M     |This field contains the realm of the       |
|                        |      |operator domain. The realm will be         |
|                        |      |addressed with the domain address of the   |
|                        |      |corresponding public URI.                  |
|Accounting-Record-Type  |M     |This field defines the transfer type: event|
|                        |      |for event based charging and start,        |
|                        |      |interim, stop for session based charging.  |
|Accounting-Record-Number|M     |This field contains the sequence number of |
|                        |      |the transferred messages.                  |
|Acct-Application-Id     |OM    |The field corresponds to the application ID|
|                        |      |of the Diameter Accounting Application and |
|                        |      |is defined with the value 3.               |
|Vendor-Specific-Applicat|-     |Not used in 3GPP.                          |
|ion-Id                  |      |                                           |
| Vendor-Id              |-     |Not used in 3GPP.                          |
| Auth-Application-Id    |-     |Not used in 3GPP.                          |
| Acct-Application-Id    |-     |Not used in 3GPP.                          |
|User-Name               |OC    |Contains the user name determined by the   |
|                        |      |domain: bearer, sub-system or service as   |
|                        |      |described in middle tier TS.               |
|Destination-Host        |OC    |This field contains the destination address|
|                        |      |of the CDF.                                |
|Accounting-Sub-Session-I|-     |Not used in 3GPP.                          |
|d                       |      |                                           |
|Accounting-Session-Id   |-     |Not used in 3GPP.                          |
|Acct-Multi-Session-Id   |-     |Not used in 3GPP.                          |
|Acct-Interim-Interval   |OC    |This field contains the proposal for       |
|                        |      |instructions to produce records            |
|                        |      |continuously during a session.             |
|Accounting-Realtime-Requ|-     |Not used in 3GPP.                          |
|ired                    |      |                                           |
|Origin-State-Id         |OC    |This field contains the state associated to|
|                        |      |the CTF.                                   |
|Event-Timestamp         |OC    |This field corresponds to the exact time   |
|                        |      |the accounting is requested.               |
|Proxy-Info              |OC    |This field contains information of the     |
|                        |      |host.                                      |
| Proxy-Host             |M     |This field contains the identity of the    |
|                        |      |host that added the Proxy-Info field.      |
| Proxy-State            |M     |This field contains state local            |
|                        |      |information.                               |
|Route-Record            |Oc    |This field contains an identifier inserted |
|                        |      |by a relaying or proxying node to identify |
|                        |      |the node it received the message from.     |
|Service-Context-Id      |OM    |This field indicates the service and the   |
|                        |      |corresponding 'middle tier' TS.            |
|Service-Information     |OM    |This parameter holds the individual service|
|                        |      |specific parameters as defined in the      |
|                        |      |corresponding 'middle tier' TS.            |
|AVP                     |Oc    |This field contains extended Information.  |


  NOTE:  A detailed description of the AVPs is provided in clause 7.



         6.2.3  Accounting-Answer (ACA) message

The ACA messages, indicated by the Command-Code field set to 271 is sent by
the CDF to the CTF in order to reply to the ACR.

The ACA message format is defined according to the Diameter Base Protocol
in RFC 6733 [401] as follows:

      <ACA> ::= < Diameter Header: 271, PXY >

               < Session-Id >
                { Result-Code }
                [ Experimental-Result ]
                { Origin-Host }
                { Origin-Realm }
                { Accounting-Record-Type }
                { Accounting-Record-Number }
                [ Acct-Application-Id ]
                [ Vendor-Specific-Application-Id ]
                [ User-Name ]
                [ Accounting-Sub-Session-Id ]
                [ Acct-Session-Id ]
                [ Acct-Multi-Session-Id ]
                [ Error-Message ]
                [ Error-Reporting-Host ]
                [ Acct-Interim-Interval ]
         [ Failed-AVP ]
                [ Accounting-Realtime-Required ]
                [ Origin-State-Id ]
                [ Event-Timestamp ]
              * [ Proxy-Info ]
              * [ AVP ]

Table 6.2.3.1 illustrates the basic structure of a 3GPP Diameter Accounting-
Answer message as used for offline charging. This message is always used by
the CDF as specified below, regardless of the CTF it is received from and
the ACR record type that is being replied to.

         Table 6.2.3.1: 3GPP Accounting-Answer (ACA) message content

|AVP                   |Catego|Description                                |
|                      |ry    |                                           |
|Session-Id            |M     |This field identifies the operation        |
|                      |      |session.                                   |
|Result-Code           |M     |This field contains the result of the      |
|                      |      |specific query.                            |
|Experimental-Result   |OC    |This field contains the Experimental result|
|                      |      |of the specific query.                     |
|Origin-Host           |M     |This field contains the identification of  |
|                      |      |the source point of the operation and the  |
|                      |      |realm of the operation originator.         |
|Origin-Realm          |M     |This field contains the realm of the       |
|                      |      |operation originator.                      |
|Accounting-Record-Type|M     |This field defines the transfer type: event|
|                      |      |for event based charging and start,        |
|                      |      |interim, stop for session based charging.  |
|Accounting-Record-Numb|M     |This field contains the sequence number of |
|er                    |      |the transferred messages.                  |
|Acct-Application-Id   |OM    |The field corresponds to the application ID|
|                      |      |of the Diameter Accounting Application and |
|                      |      |is defined with the value 3.               |
|Vendor-Specific-Applic|-     |Not used in 3GPP                           |
|ation-Id              |      |                                           |
| Vendor-Id            |-     |Not used in 3GPP                           |
| Auth-Application-Id  |-     |Not used in 3GPP                           |
| Acct-Application-Id  |-     |Not used in 3GPP                           |
|User-Name             |OC    |Contains the user name determined by the   |
|                      |      |domain: bearer, sub-system or service as   |
|                      |      |described in middle tier TS.               |
|Accounting-Sub-Session|-     |Not used in 3GPP                           |
|-Id                   |      |                                           |
|Accounting-RADIUS-Sess|-     |Not used in 3GPP                           |
|ion-Id                |      |                                           |
|Acct-Multi-Session-Id |-     |Not used in 3GPP                           |
|Error-Message         |OC    |This field contains a human readable error |
|                      |      |message.                                   |
|Error-Reporting-Host  |OC    |This field contains the identity of the    |
|                      |      |Diameter host that sent the Result-Code AVP|
|                      |      |to a value other than 2001 (Success) if the|
|                      |      |host setting the Result-Code is different  |
|                      |      |from the one encoded in the Origin-Host    |
|                      |      |AVP.                                       |
|Acct-Interim-Interval |OC    |This field contains the instructions to    |
|                      |      |produce records continuously during a      |
|                      |      |session.                                   |
|Accounting-Realtime-Re|-     |Not used in 3GPP                           |
|quired                |      |                                           |
|Failed-AVP            |OC    |This field contains the AVP that could not |
|                      |      |be processed sucessfully. This field can   |
|                      |      |occur only once.                           |
|Origin-State-Id       |OC    |This field contains the state associated to|
|                      |      |the source point of the operation.         |
|Event-Timestamp       |OC    |This field contains the time when the      |
|                      |      |operation is requested.                    |
|Proxy-Info            |OC    |This field contains information of the     |
|                      |      |host.                                      |
| Proxy-Host           |M     |This field contains the identity of the    |
|                      |      |host that added the Proxy-Info field.      |
| Proxy-State          |M     |This field contains state local            |
|                      |      |information.                               |
|AVP                   |OC    |This field contains extended Information.  |




         6.3  Basic principles for Diameter online charging


6.3.1  Online Specific Credit-Control application requirements

For online charging, the basic functionality as defined by the IETF
Diameter Credit-Control Application is used.
The basic structure follows a mechanism where the online client (CTF)
requests resource allocation and reports Credit-Control information to the
Online Charging System (OCS).

The usage and values of Validity-Time AVP and the timer "Tcc" are under the
sole control of the Credit-Control server (OCS) and determined by operator
configuration of the OCS.

The online client implements the state machine described in RFC 4006 [402]
for "CLIENT, EVENT BASED" and/or "CLIENT, SESSION BASED". I.e. when the
client applies IEC it uses the "CLIENT, EVENT BASED" state machine, and
when the client applies ECUR defined in 3GPP it uses the "CLIENT, SESSION
BASED" state machine for the first and final interrogations.

The OCS implements the state machine described in RFC 4006 [402] for the
"SERVER, SESSION AND EVENT BASED" in order to support Immediate Event
Charging and Event Charging with Unit Reservation.


6.3.2  Diameter description on the Ro reference point


6.3.2.1  Basic principles

For online charging the Diameter Credit-Control Application (DCCA) defined
in RFC 4006 [402] is used with additional AVPs defined in the present
document.

Three cases for control of user credit for online charging are
distinguished:

  -  Immediate Event Charging IEC; and

  -  event charging with unit reservation (ECUR).

  -  Session Charging with Unit Reservation (SCUR)

In the case of Immediate Event Charging (IEC),the Credit-Control process
for events is controlled by the corresponding CC-Requested-Type
EVENT_REQUEST that is sent with Credit-Control-Request (CCR) for a given
Credit-Control event.

In the case of Event Charging with Unit Reservation (ECUR) the CC-Request-
Type INITIAL / TERMINATION_REQUEST are used for charging for a given Credit-
Control event, however, where a reservation is made prior to service
delivery and committed on execution of a successful delivery.

Session Charging with Unit Reservation is used for Credit-Control of
sessions and uses the CC-Request-Type INITIAL / UPDATE and
TERMINATION_REQUEST.

The Network Element may apply IEC, where CCR event messages are generated,
or ECUR, using CCR Initial and Termination. The decision whether to apply
IEC or ECUR is based on the service and/or operator's policy.



         6.3.3  Immediate Event Charging (IEC)

Figure 6.3.3.1 shows the transactions that are required on the Ro reference
point in order to perform event based Direct Debiting operation. The Direct
Debiting operation may alternatively be carried out prior to
service/content delivery.
the Network Element shall ensure that the requested service execution is
successful, when this scenario is used.

                                    [pic]

               Figure 6.3.3.1: IEC - Direct Debiting operation

  Step 1.  The Network Element receives a service request.
       The Direct Debiting operation is performed as described in RFC 4006
       [402].

  Step 2.  The Network Element performs direct debiting prior to service
       execution. Network element (acting as DCCA client) sends CCR with CC-
       Request-Type AVP set to EVENT_REQUEST to indicate service specific
       information to the OCS (acting as DCCA server). The Requested-Action
       AVP (RA) is set to DIRECT_DEBITING. If known, the Network Element may
       include Requested-Service-Unit AVP (RSU) (monetary or non-monetary
       units) in the request message.

  Step 3.  Having transmitted the CCR message the Network Element starts
       the communication supervision timer 'Tx' (RFC 4006 [402]). Upon
       receipt of the Credit-Control- Answer (CCA) message the Network
       Element shall stop timer Tx.

  Step 4.  The OCS determines the relevant service charging parameters.

  Step 5.  The OCS returns CCA message with CC-Request-Type AVP set to
       EVENT_REQUEST to the Network Element in order to authorize the
       service execution
       (Granted-Service-Unit AVP (GSU) and possibly Cost-Information AVP
       (CI) indicating the cost of the service and Remaining-Balance AVP are
       included in the CCA message).
       The CCA message has to be checked by the Network Element accordingly
       and the requested service is controlled concurrently with service
       delivery. The Refund-Information AVP may be included in the CCA
       message in order to be sent during  the REFUND-ACCOUNT mechanism, see
       below scenario.

  Step 6.  Service is being delivered.

  NOTE:  It is possible to perform also, CHECK_BALANCE and PRICE_ENQUIRY
         using above described mechanism RFC 4006 [402].

Figure 6.3.3.2 shows the transactions for refund purpose.

                                    [pic]

     Figure 6.3.3.2: IEC - Direct Debiting operation for refund purpose

The Direct debiting operation is performed, previously, as described in RFC
4006 [402].

  Step 1.  The service charged previously through Direct Debiting Operation
       is finally proved to be unsuccessfully delivered.

  Step 2.  As a consequence, the Network Element performs direct debiting
       operation in order to perform the related refund. Network element
       (acting as DCCA client) sends CCR with CC-Request-Type AVP set to
       EVENT_REQUEST to indicate service specific information to the OCS
       (acting as DCCA server). The Requested-Action AVP (RA) is set to
       REFUND-ACCOUNT.
       The Network Element includes Refund-Information AVP if received in
       the previous IEC CCA.

  Step 3.  Having transmitted the CCR message the Network Element starts
       the communication supervision timer 'Tx' (RFC 4006 [402]). Upon
       receipt of the Credit-Control- Answer (CCA) message the Network
       Element shall stop timer Tx.

  Step 4.  The OCS reads the AVPs included in the CCR and performs the
       refund accordingly.

  Step 5.  The OCS returns CCA message with CC-Request-Type AVP set to
       EVENT_REQUEST and the related result code.




6.3.4  Event Charging with Unit Reservation (ECUR)

Figure 6.3.4.1 shows the transactions that are required on the Ro reference
point in order to perform the ECUR. ECUR is used when event charging needs
separate reserve and commit actions.

                                    [pic]

             Figure 6.3.4.1: ECUR - Session based Credit-Control

  Step 1.  The Network Element receives a service request. The service
       request may be initiated either by the user or the other Network
       Element.

  Step 2.  In order to perform Reserve Units operation for a number of
       units (monetary or non-monetary units), the Network Element sends a
       CCR with CC-Request-Type AVP set to INITIAL_REQUEST to the OCS. If
       known, the Network Element may include Requested-Service-Unit (RSU)
       AVP (monetary or non monetary units) in the request message.

  Step 3.  If the service cost information is not received by the OCS, the
       OCS determines the price of the desired service according to the
       service specific information received by issuing a rating request to
       the Rating Function. If the cost of the service is included in the
       request, the OCS directly reserves the specified monetary amount. If
       the credit balance is sufficient, the OCS reserves the corresponding
       amount from the users account.

  Step 4.  Once the reservation has been made, the OCS returns CCA message
       with CC-Request-Type set to INITIAL_REQUEST to the Network Element in
       order to authorize the service execution (Granted-Service-Unit and
       possibly Cost-Information indicating the cost of the service and
       Remaining-Balance AVP are included in the CCA message).  The OCS may
       return the Validity-Time (VT) AVP with value field set to a non-zero
       value. The OCS may indicate in the Low-Balance-Indication AVP that
       the subscriber account balance has fallen below a predefined treshold
       of this account.

  Step 5.  Content/service delivery starts and the reserved units are
       concurrently controlled.

  Step 6.  When content/service delivery is completed, the Network Element
       sends CCR with CC-Request-Type AVP set to TERMINATION_REQUEST to
       terminate the active Credit-Control session and report the used
       units.

  Step 7.  The OCS deducts the amount used from the account. Unused
       reserved units are released, if applicable.

  Step 8.  The OCS acknowledges the reception of the CCR message by sending
       CCA message with CC-Request-Type AVP indicating TERMINATION_REQUEST
       (possibly Cost-Information AVP indicating the cumulative cost of the
       service and Remaining-Balance AVP are included in the CCA message).

  NOTE:  This scenario is supervised by corresponding timers (e.g. validity
         time timer) that are not shown in the figure 6.3.4.1.



         6.3.5  Session Charging with Unit Reservation (SCUR)

Figure 6.3.5.1 shows the transactions that are required on the Ro reference
point in order to perform the SCUR.

                                    [pic]

            Figure 6.3.5.1: SCUR - Session based CCredit-Control

  Step 1.  The Network Element receives a session initiation. The session
       initiation may be done either by the user or the other Network
       Element.

  Step 2.  In order to perform Reserve Units operation for a number of
       units (monetary or non-monetary units), the Network Element sends a
       CCR with CC-Request-Type AVP set to INITIAL_REQUEST to the OCS. If
       known, the Network Element may include Requested-Service-Unit (RSU)
       AVP (monetary or non monetary units) in the request message.

  Step 3.  If the service cost information is not received by the OCS, the
       OCS determines the price of the desired service according to the
       service specific information received by issuing a rating request to
       the Rating Function. If the cost of the service is included in the
       request, the OCS directly reserves the specified monetary amount. If
       the credit balance is sufficient, the OCS reserves the corresponding
       amount from the users account.

  Step 4.  Once the reservation has been made, the OCS returns CCA message
       with CC-Request-Type set to INITIAL_REQUEST to the Network Element in
       order to authorize the service execution (Granted-Service-Unit and
       possibly Cost-Information indicating the cost of the service and
       Remaining-Balance AVP are included in the CCA message).  The OCS may
       return the Validity-Time (VT) AVP with value field set to a non-zero
       value. The OCS may indicate in the Low-Balance-Indication AVP that
       the subscriber account balance has fallen below a predefined
       threshold of this account.

  Step 5.  Content/service delivery starts and the reserved units are
       concurrently controlled.

  Step 6.  During session delivery, in order to perform Debit Units and
       subsequent Reserve Units operations, the Network Element sends a CCR
       with CC-Request-Type AVP set to UPDATE_REQUEST, to report the units
       used and request additional units, respectively. The CCR message with
       CC-Request-Type AVP set to UPDATE_REQUEST shall be sent by the
       Network Element between the INITIAL_REQUEST and TERMINATION_REQUEST
       either on request of the Credit-Control application within the
       validity time or if the validity time is elapsed. If known, the
       Network Element may include Requested-Service-Unit AVP (monetary or
       non monetary units) in the request message.  The Used-Service-Unit
       (USU) AVP is complemented in the CCR message to deduct units from
       both the user's account and the reserved units, respectively.

  Step 7.  The OCS deducts the amount used from the account. If the service
       cost information is not received by the OCS, the OCS determines the
       price of the desired service according to the service specific
       information received by issuing a rating request to the Rating
       Function. If the cost of the service is included in the request, the
       OCS directly reserves the specified monetary amount. If the credit
       balance is sufficient, the OCS reserves the corresponding amount from
       the users account.

  Step 8.  Once the deduction and reservation have been made, the OCS
       returns CCA message with CC-Request-Type set to UPDATE_REQUEST to the
       Network Element, in order to allow the content/service delivery to
       continue (new Granted-Service-Unit (GSU) AVP and possibly Cost-
       Information (CI) AVP indicating the cumulative cost of the service
       and Remaining-Balance AVP are included in the CCA message). The OCS
       may include in the CCA message the Final-Unit-Indication (FUI) AVP to
       indicate the final granted units. The OCS may indicate in the Low-
       Balance-Indication AVP that the subscriber account balance has fallen
       below a predefined threshold of this account.

  Step 9.  Session delivery continues and the reserved units are
       concurrently controlled.

  Step 10. The session is terminated at the Network Element.

  Step 11.    The Network Element sends CCR with CC-Request-Type AVP set to
       TERMINATION_REQUEST to terminate the active Credit-Control session
       and report the used units.

  Step 12. The OCS deducts the amount used from the account. Unused
       reserved units are released, if applicable.

  Step 13. The OCS acknowledges the reception of the CCR message by sending
       CCA message with CC-Request-Type AVP indicating TERMINATION_REQUEST
       (possibly Cost-Information AVP indicating the cumulative cost of the
       service and Remaining-Balance AVP are included in the CCA message).

  NOTE:  This scenario is supervised by corresponding timers (e.g. validity
         time timer) that are not shown in figure 6.3.5.1.



         6.3.6  Error cases and scenarios


6.3.6.0  Introduction

This clause describes various error cases and how these should be handled.

The failure handling behaviour is locally configurable in the Network
Element. If the Direct-Debiting-Failure-Handling or Credit-Control-Failure-
Handling AVP is not used, the locally configured values are used instead.


6.3.6.1  Duplicate detection

The detection of duplicate request is needed and shall be enabled. To speed
up and simplify as much as possible the duplicate detection, the all-
against-all record checking should be avoided and just those records marked
as potential duplicates need to be checked against other received requests
(in real-time ) by the receiver entity.

The Network Element marks the request messages that are retransmitted after
a link fail over as possible duplicates with the T-flag as described in RFC
6733 [401]. For optimized performance, uniqueness checking against other
received requests is only necessary for those records marked with the T-
flag received within a reasonable time window. This focused check is based
on the inspection of the Session-Id and CC-Request-Number AVP pairs.

Note that for EBCC the duplicate detection is performed in the Correlation
Function that is part of the OCS.
The OCS that receives the possible duplicate request should mark as
possible duplicate the corresponding request that is sent over the 'Rc'
reference point. However, this assumption above is for further study and
needs to be clarified.

For Credit-Control duplicate detection, please refer to the Diameter Credit-
Control.


6.3.6.2  Reserve Units / Debit Units operation failure

In the case of an OCS connection failure, and/or receiving error responses
from the OCS, please refer to RFC 6733 [401] and RFC 4006 [402] for failure
handling descriptions.


6.3.7  Support of tariff changes during an active user session


6.3.7.1  Support of tariff changes using the tariff switch mechanism

After a tariff switch has been reached, all the active user sessions shall
report their session usage by the end of the validity period of the current
request and receive new quota for resource usage for the new tariff period.


In order to avoid the need for mass simultaneous quota refresh, the traffic
usage can be split into resource usage before a tariff switch and resources
used after a tariff switch.

The Tariff-Time-Change AVP is used to determine the tariff switch time as
described by RFC 4006 [402].
In addition to the scenarios described in RFC 4006 [402], the Tariff-Time-
Change AVP may also be used in the context of continuously time-based
charging.

The Tariff-Change-Usage AVP is used within the Used-Service-Units AVP to
distinguish reported usage before and after the tariff time change.

The Tariff-Change-Usage AVP is not used directly within the Multiple-
Services-Credit-Control AVP.


6.3.7.2  Support of tariff changes using Validity-Time AVP

Changes to the tariffs pertaining to the service during active user
sessions may also be handled using the Validity Time AVP.

  NOTE:  RFC 4006 [402] does not directly describe how tariff changes are
         handled with validity time.
         If validity time is used for tariff time changes it might overload
         the client and the server.



         6.3.8  Support of re-authorization

Mid Diameter CC session re-authorizations of multiple active resource
quotas within a DCC session can be achieved using a single Diameter Credit-
Control- Request/ Credit-Control- Answer message sequence.

The OCS may also re-authorize multiple active resource quotas within a DCC
session by using a single Diameter Re-Auth-Request/Answer message sequence.


New quota allocations received by the Network Element override any
remaining held quota resources after accounting for any resource usage
while the re-authorization was in progress.


6.3.9  Support of failure handling

The Credit-Control-Failure-Handling AVP as defined in RFC 4006 [402]
determines what to do if the sending of Diameter credit-control messages to
the OCS has been temporarily prevented. The usage of Credit-Control-Failure-
Handling AVP gives flexibility to have different failure handling for
credit-control session.

This AVP may be received from the OCS or may be locally configured. The
value received from the OCS in the Diameter CCA message always override any
already existing value.

As defined in RFC 4006 [402], the Tx timer is introduced to limit the
waiting time in the CTF for an answer to the CCR sent to the OCS. When the
Tx timer elapses the CTF takes an action to the end user according to the
value of the Credit-Control-Failure-Handling AVP.

It is possible that several concurrent CCR messages are triggered for the
same online charging session. In this case, each CCR message shall reset
the Tx timer as defined in RFC 4006 [402].


6.3.10 Support of failover

As defined in RFC 4006 [402] if a failure occurs during an ongoing credit-
control session, the CTF may move the Credit-Control message stream to an
alternative OCS if the primary OCS indicated FAILOVER_SUPPORTED in the CC-
Session-Failover AVP. In case CC-Session-Failover AVP is set to
FAILOVER_NOT SUPPORTED the Credit-Control message stream is not moved to a
backup OCS.

For new Credit-Control sessions, failover to an alternative OCS should be
performed if possible. For instance, if an implementation of the CTF can
determine primary OCS unavailability it can establish the new Credit-
Control sessions with a possibly available secondary OCS.

Since the OCS has to maintain session states, moving the credit-control
message stream to a backup OCS requires a complex charging context transfer
solution. This charging context transfer mechanism by OCS is out of the
scope of  the 3GPP standardization work.


6.3.11 Credit pooling

Credit pooling shall be supported as described in TS 32.240 [1].

  NOTE:  Credit pooling is not applicable to IEC since there is no quota
         management between CTF and OCF.



         6.4  Message formats for online charging


6.4.1  Summary of online charging message formats


6.4.1.1  General

The corresponding Diameter Credit-Control application messages for the
Debit / Reserve Unit Request operation is Credit-Control-Request (CCR) and
for the Debit / Reserve Unit Response operation is Credit-Control-Answer
(CCA) as specified in RFC 4006 [402].

The Diameter Credit-Control Application (DCCA) specifies an approach based
on a series of "interrogations":

1. Initial interrogation.

2. Zero, one or more interim interrogations.

3. Final interrogation.

In addition to a series of interrogations, also a one time event
(interrogation) can be used e.g. in the case when service execution is
always successful.

All of these interrogations use CCR and CCA messages. The CCR for the
"interim interrogation" and "final interrogation" reports the actual number
of "units" that were used, from what was previously reserved. This
determines the actual amount debited from the subscriber's account.

Table 6.4.1.1.1 describes the use of these Diameter messages which are
adapted for 3GPP online charging.

          Table 6.4.1.1.1: Online charging messages reference table

|Command-Name            |Source  |Destination  |Abbreviatio|
|                        |        |             |n          |
|Credit-Control-Request  |CTF     |OCS          |CCR        |
|Credit-Control-Answer   |OCS     |CTF          |CCA        |
|Capabilities-Exchange-Re|CTF     |OCS          |CER        |
|quest                   |        |             |           |
|Capabilities-Exchange-An|OCS     |CTF          |CEA        |
|swer                    |        |             |           |


Additional Diameter messages (i.e. ASR/ASA, DPR/DPA, DWR/DWA, RAR/RAA) are
used according to the Diameter Base Protocol Accounting (DBPA)
specification in RFC 6733 [401] and to the DCCA specification in RFC 4006
[402].


6.4.1.2  Structure for the Credit-Control message formats

The following is the basic structure shared by all online charging
messages. This is based directly on the format of the messages defined in
RFC 4006 [402].

Those Diameter accounting AVPs that are used for 3GPP online charging are
marked in the table of contents 6.4.2 and 6.4.3 with a category as
specified in TS 32.240 [1].

In the definition of the Diameter commands, the AVPs that are specified in
the referenced specifications but not used by the 3GPP charging
specifications are marked with strikethrough, e.g. [ Acct-Multi-Session-Id
].

The following symbols are used in the message format definitions:

-  <AVP> indicates a mandatory AVP with a fixed position in the message.

-  {AVP} indicates a mandatory AVP in the message.

-  [AVP] indicates an optional AVP in the message.

-  *AVP indicates that multiple occurrences of an AVP is possible.



         6.4.2  Credit-Control-Request message

The CCR messages, indicated by the Command-Code field set to 272 is sent by
the CTF to the OCF in order to request credits for the request bearer /
subsystem /service.

The CCR message format is defined according to RFC 4006 [402] as follows:

      <CCR> ::= < Diameter Header: 272, REQ, PXY >

          < Session-Id >
                 { Origin-Host }
                 { Origin-Realm }
                 { Destination-Realm }
                 { Auth-Application-Id }
                 { Service-Context-Id }
                 { CC-Request-Type }
                 { CC-Request-Number }
                 [ Destination-Host ]
                 [ User-Name ]
                 [ CC-Sub-Session-Id ]
                 [ Acct-Multi-Session-Id ]
                 [ Origin-State-Id ]
                 [ Event-Timestamp ]
                *[ Subscription-Id ]
                 [ Service-Identifier ]
                 [ Termination-Cause ]
                 [ Requested-Service-Unit ]
                 [ Requested-Action ]
                *[ Used-Service-Unit ]
                 [ AoC-Request-Type ]
                 [ Multiple-Services-Indicator ]
                *[ Multiple-Services-Credit-Control ]
                *[ Service-Parameter-Info ]
                 [ CC-Correlation-Id ]
                 [ User-Equipment-Info ]
                 [ OC-Supported-Features ]
         *[ Proxy-Info ]
         *[ Route-Record ]
          [ Service-Information ]
         *[ AVP ]


Table 6.4.2.1 illustrates the basic structure of a 3GPP Diameter CCR
message as used for online charging.

                   Table 6.4.2.1: 3GPP CCR message content

|AVP                       |Catego|Description                              |
|                          |ry    |                                         |
|Session-Id                |M     |This field identifies the operation      |
|                          |      |session.                                 |
|Origin-Host               |M     |This field contains the identification of|
|                          |      |the source point of the operation and the|
|                          |      |realm of the operation originator.       |
|Origin-Realm              |M     |This field contains the realm of the     |
|                          |      |operation originator.                    |
|Destination-Realm         |M     |This field contains the realm of the     |
|                          |      |operator domain. The realm will be       |
|                          |      |addressed with the domain address of the |
|                          |      |corresponding public URI.                |
|Auth-Application-Id       |M     |The field corresponds to the application |
|                          |      |ID of the Diameter Credit-Control        |
|                          |      |Application and is defined with the value|
|                          |      |4.                                       |
|Service-Context-Id        |M     |This field indicates the supported       |
|                          |      |protocol version.                        |
|CC-Request-Type           |M     |This field defines the transfer type:    |
|                          |      |event for event based charging and       |
|                          |      |initial, update, terminate for session   |
|                          |      |based charging.                          |
|CC-Request-Number         |M     |This field contains the sequence number  |
|                          |      |of the transferred messages.             |
|Destination-Host          |OC    |This field contains the destination peer |
|                          |      |address of the OCS identity.             |
|User-Name                 |OC    |Contains the user name determined by the |
|                          |      |domain: bearer, sub-system or service as |
|                          |      |described in middle tier TS.             |
|CC-Sub-Session-Id         |-     |Not used in 3GPP.                        |
|Acct-Multi-Session-Id     |-     |Not used in 3GPP.                        |
|Origin-State-Id           |OC    |This field contains the state associated |
|                          |      |to the CTF.                              |
|Event-Timestamp           |OC    |This field corresponds to the exact time |
|                          |      |the quota is requested.                  |
|Subscription-Id           |OM    |This field contains the identification of|
|                          |      |the user that is going to access the     |
|                          |      |service in order to be identified by the |
|                          |      |OCS.                                     |
| Subscription-Id-Type     |M     |This field determines the type of the    |
|                          |      |identifier, e.g. t value 0 is used for   |
|                          |      |the international E.164 format according |
|                          |      |to ITU-T E.164 numbering plan.           |
| Subscription-Id-Data     |M     |This field contains the user data content|
|                          |      |e.g. the MSISDN.                         |
|Service-Identifier        |-     |Not used in 3GPP.                        |
|Termination-Cause         |OC    |This field contains the reason the       |
|                          |      |Credit-Control session was terminated.   |
|Requested-Service-Unit    |-     |Not used in 3GPP, see                    |
|                          |      |Multiple-Services-Credit-Control.        |
| CC-Time                  |-     |Not used in 3GPP.                        |
| CC-Money                 |-     |Not used in 3GPP.                        |
|  Unit-Value              |-     |Not used in 3GPP.                        |
|   Value-Digits           |-     |Not used in 3GPP.                        |
|   Exponent               |-     |Not used in 3GPP.                        |
|  Currency-Code           |-     |Not used in 3GPP.                        |
| CC-Total-Octets          |-     |Not used in 3GPP.                        |
| CC-Input-Octets          |-     |Not used in 3GPP.                        |
| CC-Output-Octets         |-     |Not used in 3GPP.                        |
| CC-Service-Specific-Units|-     |Not used in 3GPP.                        |
| AVP                      |-     |Not used in 3GPP.                        |
|Requested-Action          |OC    |The field defines the type of action if  |
|                          |      |the CC-Request-Type indicates EVENT.     |
|AoC-Request-Type          |Oc    |This field denotes if AoC Information is |
|                          |      |requested and what type of information is|
|                          |      |needed.                                  |
|Used-Service-Unit         |-     |Not used in 3GPP, see                    |
|                          |      |Multiple-Services-Credit-Control.        |
| Tariff-Change-Usage      |-     |Not used in 3GPP.                        |
| CC-Time                  |-     |Not used in 3GPP.                        |
| CC-Money                 |-     |Not used in 3GPP.                        |
|  Unit-Value              |-     |Not used in 3GPP.                        |
|   Value-Digits           |-     |Not used in 3GPP.                        |
|   Exponent               |-     |Not used in 3GPP.                        |
|  Currency-Code           |-     |Not used in 3GPP.                        |
| CC-Total-Octets          |-     |Not used in 3GPP.                        |
| CC-Input-Octets          |-     |Not used in 3GPP.                        |
| CC-Output-Octets         |-     |Not used in 3GPP.                        |
| CC-Service-Specific-Units|-     |Not used in 3GPP.                        |
| AVP                      |-     |Not used in 3GPP.                        |
|Multiple-Services-Indicato|OM    |This field indicates whether the CTF is  |
|r                         |      |capable of handling multiple services    |
|                          |      |independently.                           |
|Multiple-Services-Credit-C|OC    |This field contains all parameters for   |
|ontrol                    |      |the CTF quota management and defines the |
|                          |      |quotas to allow traffic to flow.         |
| Granted-Service-Unit     |-     |Not used in CCR.                         |
|  Tariff-Time-Change      |-     |Not used in CCR.                         |
|  CC-Time                 |-     |Not used in CCR.                         |
|  CC-Money                |-     |Not used in 3GPP.                        |
|   Unit-Value             |-     |Not used in 3GPP.                        |
|    Value-Digits          |-     |Not used in 3GPP.                        |
|    Exponent              |-     |Not used in 3GPP.                        |
|   Currency-Code          |-     |Not used in 3GPP.                        |
|  CC-Total-Octets         |-     |Not used in CCR.                         |
|  CC-Input-Octets         |-     |Not used in CCR.                         |
|  CC-Output-Octets        |-     |Not used in CCR.                         |
|                          |-     |Not used in CCR.                         |
|CC-Service-Specific-Units |      |                                         |
|   AVP                    |-     |Not used in 3GPP.                        |
| Requested-Service-Unit   |OC    |This field contains the amount of        |
|                          |      |requested service units for a particular |
|                          |      |category or an indication that units are |
|                          |      |needed for a particular category, as     |
|                          |      |defined in DCCA [402].                   |
|  CC-Time                 |OC    |This field contains the amount of        |
|                          |      |requested time.                          |
|  CC-Money                |-     |Not used in 3GPP.                        |
|   Unit-Value             |-     |Not used in 3GPP.                        |
|    Value-Digits          |-     |Not used in 3GPP.                        |
|    Exponent              |-     |Not used in 3GPP.                        |
|   Currency-Code          |-     |Not used in 3GPP.                        |
|  CC-Total-Octets         |OC    |This field contains the requested amount |
|                          |      |of octets to be sent and received.       |
|  CC-Input-Octets         |OC    |This field contains the requested amount |
|                          |      |of octets to be received.                |
|  CC-Output-Octets        |OC    |This field contains the requested amount |
|                          |      |of octets to be sent.                    |
|                          |OC    |This field contains the requested amount |
|CC-Service-Specific-Units |      |of service specific units, e.g. number of|
|                          |      |events.                                  |
|  AVP                     |-     |Not used in 3GPP.                        |
| Used-Service-Unit        |OC    |This field contains the amount of used   |
|                          |      |non-monetary service units measured for a|
|                          |      |particular category to a particular quota|
|                          |      |type.                                    |
|  Reporting-Reason        |OC    |Used as defined in clause 7.2.           |
|  Tariff-Change-Usage     |OC    |This field identifies the reporting      |
|                          |      |period for the used service unit, i.e.   |
|                          |      |before, after or during tariff change.   |
|  CC-Time                 |OC    |This field contains the amount of used   |
|                          |      |time.                                    |
|  CC-Money                |-     |Not used in 3GPP.                        |
|   Unit-Value             |-     |Not used in 3GPP.                        |
|    Value-Digits          |-     |Not used in 3GPP.                        |
|    Exponent              |-     |Not used in 3GPP.                        |
|   Currency-Code          |-     |Not used in 3GPP.                        |
|  CC-Total-Octets         |OC    |This field contains the amount of sent   |
|                          |      |and received octets.                     |
|  CC-Input-Octets         |OC    |This field contains the amount of        |
|                          |      |received octets.                         |
|  CC-Output-Octets        |OC    |This field contains the amount of sent   |
|                          |      |octets.                                  |
|                          |OC    |This field contains the amount of service|
|CC-Service-Specific-Units |      |specific units, e.g. number of events.   |
|  Event-Charging-TimeStamp|Oc    |Used as defined in clause 7.2.           |
|  AVP                     |-     |Not used in 3GPP.                        |
| Tariff-Change-Usage      |-     |Not used in 3GPP .                       |
| Service-Identifier       |OC    |This field contains identity of the used |
|                          |      |service. This ID with the                |
|                          |      |Service-Context-ID together forms an     |
|                          |      |unique identification of the service.    |
| Rating-Group             |OC    |This field contains the identifier of a  |
|                          |      |rating group.                            |
| G-S-U-Pool-Reference     |-     |Not used in CCR.                         |
|  G-S-U-Pool-Identifier   |-     |Not used in CCR.                         |
|  CC-Unit-Type            |-     |Not used in CCR.                         |
|  Unit-Value              |-     |Not used in CCR.                         |
|   Value-Digits           |-     |Not used in CCR.                         |
|   Exponent               |-     |Not used in CCR.                         |
| Validity-Time            |-     |Not used in CCR.                         |
| Result-Code              |-     |Not used in CCR.                         |
| Final-Unit-Indication    |-     |Not used in CCR.                         |
|  Final-Unit-Action       |-     |Not used in CCR.                         |
|  Restriction-Filter-Rule |-     |Not used in CCR.                         |
|  Filter-Id               |-     |Not used in CCR.                         |
|  Redirect-Server         |-     |Not used in CCR.                         |
|   Redirect-Address-Type  |-     |Not used in CCR.                         |
|   Redirect-Server-Address|-     |Not used in CCR.                         |
| Time-Quota-Threshold     |-     |Not used in CCR.                         |
| Volume-Quota-Threshold   |-     |Not used in CCR.                         |
|      Unit-Quota-Threshold|-     |Not used in CCR.                         |
| Quota-Holding-Time       |-     |Not used in CCR.                         |
| Quota-Consumption-Time   |-     |Not used in CCR.                         |
| Reporting-Reason         |OC    |Used as defined in clause 7.2.           |
| Trigger                  |OC    |Used as defined in clause 7.2.           |
|  Trigger-Type            |OC    |Used as defined in clause 7.2.           |
|                          |-     |Not used in CCR.                         |
|PS-Furnish-Charging-Inform|      |                                         |
|ation                     |      |                                         |
| Refund-Information       |OC    |Used as defined in clause 7.2.           |
|                          |OC    |Used as defined in clause 7.2.           |
|AF-Correlation-Information|      |                                         |
| Envelope                 |OC    |Used as defined in clause 7.2.           |
|  Envelope-Start-Time     |M     |Used as defined in clause 7.2.           |
|  Envelope-End-Time       |OC    |Used as defined in clause 7.2.           |
|  CC-Total-Octets         |OC    |Used as defined in clause 7.2.           |
|  CC-Input-Octets         |OC    |Used as defined in clause 7.2.           |
|  CC-Output-Octets        |OC    |Used as defined in clause 7.2.           |
|                          |OC    |Used as defined in clause 7.2            |
|CC-Service-Specific-Units |      |                                         |
|      Envelop-Reporting   |OC    |Used as defined in clause 7.2.           |
|      Time-Quota-Mechanism|OC    |Used as defined in clause 7.2.           |
| Service-Specific-Info    |OC    |Used as defined in clause 7.2.           |
|  Service-Specific-Type   |OC    |Used as defined in clause 7.2.           |
|  Service-Specific-Data   |OC    |Used as defined in clause 7.2.           |
| QoS-Information          |OC    |This field contains authorized QoS       |
|                          |      |applicable for service data flow, which  |
|                          |      |initially triggers the activation of this|
|                          |      |MSCC instance. Included in first quota   |
|                          |      |request to rating group if service data  |
|                          |      |flow specific QoS control is in use, see |
|                          |      |TS 29.212 [215] for more information. For|
|                          |      |IP-CAN bearer specific Rating            |
|                          |      |Group/Service Identifier this field is   |
|                          |      |not included.                            |
|                          |      |For TDF, this field contains bandwidth   |
|                          |      |limitation applicable for application    |
|                          |      |traffic and only the                     |
|                          |      |Max-Requested-Bandwidth-UL and the       |
|                          |      |Max-Requested-Bandwidth-DL are used.     |
|  QoS-Class-Identifier    |M     |See TS 29.212 [215] for more information.|
|                          |OC    |See TS 29.212 [215] for more information.|
|Max-Requested-Bandwidth-UL|      |                                         |
|                          |OC    |See TS 29.212 [215] for more information.|
|Max-Requested-Bandwidth-DL|      |                                         |
|                          |OC    |See TS 29.212 [215] for more information.|
|Extended-Max-Requested-BW-|      |                                         |
|UL                        |      |                                         |
|                          |OC    |See TS 29.212 [215] for more information.|
|Extended-Max-Requested-BW-|      |                                         |
|DL                        |      |                                         |
|  Guaranteed-Bitrate-UL   |OC    |See TS 29.212 [215] for more information.|
|  Guaranteed-Bitrate-DL   |OC    |See TS 29.212 [215] for more information.|
|  Extended-GBR-UL         |OC    |See TS 29.212 [215] for more information.|
|  Extended-GBR-DL         |OC    |See TS 29.212 [215] for more information.|
|  Bearer-Identifier       |OC    |See TS 29.212 [215] for more information.|
|                          |OC    |See TS 29.212 [215] for more information.|
|Allocation-Retention-Prior|      |                                         |
|ity                       |      |                                         |
|   Priority-Level         |OC    |See TS 29.212 [215] for more information.|
|   Pre-emption-Capability |OC    |See TS 29.212 [215] for more information.|
|                          |OC    |See TS 29.212 [215] for more information.|
|Pre-emption-Vulnerability |      |                                         |
|                          |OC    |See TS 29.212 [215] for more information.|
|APN-Aggregate-Max-Bitrate-|      |                                         |
|UL                        |      |                                         |
|                          |OC    |See TS 29.212 [215] for more information.|
|APN-Aggregate-Max-Bitrate-|      |                                         |
|DL                        |      |                                         |
|  Extended-APN-AMBR-UL    |OC    |See TS 29.212 [215] for more information.|
|  Extended-APN-AMBR-DL    |OC    |See TS 29.212 [215] for more information.|
| Announcement-Information |OC    |Not used in CCR.                         |
|      3GPP-RAT-Type       |OC    |This field contains the RAT Type of the  |
|                          |      |IP-CAN bearer that is first reported for |
|                          |      |the Rating Group or Rating Group /       |
|                          |      |Service Identifier. If traffic from      |
|                          |      |multiple access types is included in this|
|                          |      |report, only one field is included.      |
|                          |      |                                         |
|                          |      |This field is only applicable when NBIFOM|
|                          |      |is accepted for the IP-CAN session.      |
|                          |      |                                         |
|                          |      |See TS 29.061 [207] for more information.|
|      Related-Trigger     |OC    |This field contains the trigger types for|
|                          |      |a related trigger for another access in a|
|                          |      |multi-access PDN connection. This field  |
|                          |      |is only included when the Trigger AVP    |
|                          |      |contains a Trigger-Type AVP with value of|
|                          |      |"indirect change condition" which is     |
|                          |      |applicable when charging per IP-CAN      |
|                          |      |session for a multi-access PDN           |
|                          |      |connection.                              |
| AVP                      |-     |Not used in CCR.                         |
|Service-Parameter-Info    |-     |Not used in 3GPP.                        |
| Service-Parameter-Type   |-     |Not used in 3GPP.                        |
| Service-Parameter-Value  |-     |Not used in 3GPP.                        |
|CC-Correlation-Id         |OC    |This field contains information to       |
|                          |      |correlate CCRs generated for different   |
|                          |      |components of the service, e.g.,         |
|                          |      |transport and service level.             |
|User-Equipment-Info       |OC    |This field contains the identification of|
|                          |      |the identity and terminal capability the |
|                          |      |subscriber is using for the connection to|
|                          |      |mobile network if available.             |
| User-Equipment-Info-Type |M     |This field determines the type of the    |
|                          |      |identifier. The used value is 0 for the  |
|                          |      |international mobile equipment identifier|
|                          |      |and software version according to TS     |
|                          |      |23.003[224].                             |
| User-Equipment-Info-Value|M     |This field contains the user IMEI.       |
|OC-Supported-Features     |OC    |Used as defined in IETF 7683 [411], for  |
|                          |      |more details see clause B.               |
|OC-Feature-Vector         |OC    |Used as defined in IETF 7683 [411], for  |
|                          |      |more details see clause B.               |
|Proxy-Info                |OC    |This field contains information of the   |
|                          |      |host.                                    |
| Proxy-Host               |M     |This field contains the identity of the  |
|                          |      |host that added the Proxy-Info field.    |
| Proxy-State              |M     |This field contains state local          |
|                          |      |information.                             |
|Route-Record              |OC    |This field contains an identifier        |
|                          |      |inserted by a relaying or proxying node  |
|                          |      |to identify the node it received the     |
|                          |      |message from.                            |
|Service-Information       |OM    |This parameter holds the individual      |
|                          |      |service specific parameters as defined in|
|                          |      |the corresponding 'middle tier' TS.      |
|AVP                       |OC    |This field contains extended Information.|




         6.4.3  Credit-Control-Answer message

The CCA messages, indicated by the Command-Code field set to 272 is sent by
the OCF to the CTF in order to reply to the CCR.

The CCA message format is defined according to RFC 4006 [402] as follows:

      <CCA> ::=  < Diameter Header: 272, PXY >

                 < Session-Id >
                 { Result-Code }
             [ Experimental-Result ]

                 { Origin-Host }
                 { Origin-Realm }
                 { Auth-Application-Id }
                 { CC-Request-Type }
                 { CC-Request-Number }
                 [ User-Name ]
                 [ CC-Session-Failover ]
                 [ CC-Sub-Session-Id ]
                 [ Acct-Multi-Session-Id ]
                 [ Origin-State-Id ]
                 [ Event-Timestamp ]
                 [ Granted-Service-Unit ]
                *[ Multiple-Services-Credit-Control ]
                 [ Cost-Information]
                 [ Low-Balance-Indication ]
                 [ Remaining-Balance ]
                 [ Final-Unit-Indication ]
                 [ Check-Balance-Result ]
                 [ Credit-Control-Failure-Handling ]
                 [ Direct-Debiting-Failure-Handling ]
                 [ Validity-Time]
                 [ OC-Supported-Features ]
                 [ OC-OLR ]
                *[ Redirect-Host]
                 [ Redirect-Host-Usage ]
                 [ Redirect-Max-Cache-Time ]
                *[ Proxy-Info ]
                *[ Route-Record ]
                 [ Failed-AVP ]
                 [ Service-Information ]
                *[ AVP ]

Table 6.4.3.1 illustrates the basic structure of a 3GPP Diameter CCA
message as used for online charging. This message is always used by the OCF
as specified below, independent of the receiving CTF and the CCR record
type that is being replied to.

                   Table 6.4.3.1: 3GPP CCA message content

|AVP                     |Catego|Description                                |
|                        |ry    |                                           |
|Session-Id              |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Result-Code             |M     |This field contains the result of the      |
|                        |      |specific query.                            |
|Experimental-Result     |OC    |This field contains the Experimental result|
|                        |      |of the specific query.                     |
|Origin-Host             |M     |This field contains the identification of  |
|                        |      |the source point of the operation and the  |
|                        |      |realm of the operation originator.         |
|Origin-Realm            |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Auth-Application-Id     |M     |The field corresponds to the application ID|
|                        |      |of the Diameter Credit-Control Application |
|                        |      |and is defined with the value 4.           |
|CC-Request-Type         |M     |This field defines the transfer type:      |
|                        |      |initial, update, terminate for session     |
|                        |      |based charging and event for event based   |
|                        |      |charging.                                  |
|CC-Request-Number       |M     |This field contains the sequence number of |
|                        |      |the transferred messages.                  |
|User-Name               |-     |Not used in 3GPP.                          |
|CC-Session Failover     |OC    |This field contains an indication to the   |
|                        |      |CTF whether or not a failover handling is  |
|                        |      |to be used when necessary.                 |
|CC-Sub-session-Id       |-     |Not used in 3GPP.                          |
|Acct-Multi-Session-Id   |-     |Not used in 3GPP.                          |
|Origin-State-Id         |-     |Not used in 3GPP.                          |
|Event-Timestamp         |-     |Not used in 3GPP.                          |
|Granted-Service-Unit    | -    |Not used in 3GPP, see                      |
|                        |      |Multiple-Services-Credit-Control.          |
| Tariff-Time-Change     | -    |Not used in 3GPP.                          |
| CC-Time                | -    |Not used in 3GPP.                          |
| CC-Money               |-     |Not used in 3GPP.                          |
|  Unit-Value            |-     |Not used in 3GPP.                          |
|   Value-Digits         |-     |Not used in 3GPP.                          |
|   Exponent             |-     |Not used in 3GPP.                          |
|  Currency-Code         |-     |Not used in 3GPP.                          |
| CC-Total-Octets        | -    |Not used in 3GPP.                          |
| CC-Input-Octets        | -    |Not used in 3GPP.                          |
| CC-Output-Octets       |-     |Not used in 3GPP.                          |
|                        | -    |Not used in 3GPP.                          |
|CC-Service-Specific-Unit|      |                                           |
|s                       |      |                                           |
| AVP                    |-     |Not used in 3GPP.                          |
|Multiple-Services-Credit|OC    |This field contains all parameters for the |
|-Control                |      |CTF quota management and defines the quotas|
|                        |      |to allow traffic to flow.                  |
| Granted-Service-Unit   |OC    |This field contains the amount of granted  |
|                        |      |service units for a particular category.   |
|  Tariff-Time-Change    |OC    |This field contains the switch time when   |
|                        |      |the tariff will be changed.                |
|  CC-Time               |OC    |This field contains the amount of granted  |
|                        |      |time.                                      |
|  CC-Money              |-     |Not used in 3GPP.                          |
|   Unit-Value           |-     |Not used in 3GPP.                          |
|    Value-Digits        |-     |Not used in 3GPP.                          |
|    Exponent            |-     |Not used in 3GPP.                          |
|   Currency-Code        |-     |Not used in 3GPP.                          |
|  CC-Total-Octets       |OC    |This field contains the amount for sent and|
|                        |      |received octets.                           |
|  CC-Input-Octets       |OC    |This field contains the amount for received|
|                        |      |octets.                                    |
|  CC-Output-Octets      |OC    |This field contains the amount for sent    |
|                        |      |octets.                                    |
|                        |OC    |This field contains the amount for service |
|CC-Service-Specific-Unit|      |specific units, e.g. number of events.     |
|s                       |      |                                           |
|  AVP                   |-     |Not used in 3GPP.                          |
| Requested-Service-Unit |-     |Not used in CCA.                           |
|  CC-Time               |-     |Not used in CCA.                           |
|  CC-Money              |-     |Not used in 3GPP.                          |
|   Unit-Value           |-     |Not used in 3GPP.                          |
|    Value-Digits        |-     |Not used in 3GPP.                          |
|    Exponent            |-     |Not used in 3GPP.                          |
|   Currency-Code        |-     |Not used in 3GPP.                          |
|  CC-Total-Octets       |-     |Not used in CCA.                           |
|  CC-Input-Octets       |-     |Not used in CCA.                           |
|  CC-Output-Octets      |-     |Not used in CCA.                           |
|                        |-     |Not used in CCA.                           |
|CC-Service-Specific-Unit|      |                                           |
|s                       |      |                                           |
|  AVP                   |-     |Not used in 3GPP.                          |
| Used-Service-Unit      |-     |Not used in CCA.                           |
|  Reporting-Reason      |-     |Not used in CCA.                           |
|                        |-     |Not used in CCA.                           |
|Tariff-Change-Usage     |      |                                           |
|  CC-Time               |-     |Not used in CCA.                           |
|  CC-Money              |-     |Not used in 3GPP.                          |
|   Unit-Value           |-     |Not used in 3GPP.                          |
|    Value-Digits        |-     |Not used in 3GPP.                          |
|    Exponent            |-     |Not used in 3GPP.                          |
|   Currency-Code        |-     |Not used in 3GPP.                          |
|  CC-Total-Octets       |-     |Not used in CCA.                           |
|  CC-Input-Octets       |-     |Not used in CCA.                           |
|  CC-Output-Octets      |-     |Not used in CCA.                           |
|                        |-     |Not used in CCA.                           |
|CC-Service-Specific-Unit|      |                                           |
|s                       |      |                                           |
|                        |-     |Not used in CCA.                           |
|Event-Charging-TimeStamp|      |                                           |
|  AVP                   |-     |Not used in 3GPP.                          |
| Tariff-Change-Usage    |-     |Not used in 3GPP.                          |
| Service-Identifier     |OC    | This field contains identity of the used  |
|                        |      |service. This ID with the                  |
|                        |      |Service-Context-ID together forms a unique |
|                        |      |identification of the service.             |
| Rating-Group           |OC    |This field contains the identifier of a    |
|                        |      |rating group.                              |
| G-S-U-Pool-Reference   |OC    | Only used in ECUR and SCUR.               |
|  G-S-U-Pool-Identifier |M     |Used as defined in DCCA [402].             |
|  CC-Unit-Type          |M     |Used as defined in DCCA [402].             |
|  Unit-Value            |M     |Used as defined in DCCA [402].             |
|   Value-Digits         |M     |Used as defined in DCCA [402].             |
|   Exponent             |OC    |Used as defined in DCCA [402].             |
| Validity-Time          |OC    |This field defines the time in order to    |
|                        |      |limit the validity of the granted quota for|
|                        |      |a given category instance.                 |
| Result-Code            |OC    |This field contains the result of the      |
|                        |      |query.                                     |
| Final-Unit-Indication  |OC    |This field indicates that the              |
|                        |      |Granted-Service-Unit AVP containing the    |
|                        |      |final units for the service.               |
|  Final-Unit-Action     |M     |Used as defined in DCCA  [402].            |
|                        |OC    |Used as defined in DCCA  [402].            |
|Restriction-Filter-Rule |      |                                           |
|  Filter-Id             |OC    |Used as defined in DCCA  [402].            |
|  Redirect-Server       |OC    |Used as defined in DCCA  [402].            |
|   Redirect-Address-Type|M     |Used as defined in DCCA  [402].            |
|                        |M     |Used as defined in DCCA  [402].            |
|Redirect-Server-Address |      |                                           |
| Time-Quota-Threshold   |OC    |Used as defined in clause 7.2.             |
| Volume-Quota-Threshold |OC    |Used as defined in clause 7.2.             |
| Unit-Quota-Threshold   |OC    |Used as defined in clause 7.2.             |
| Quota-Holding-Time     |OC    |Used as defined in clause 7.2.             |
| Quota-Consumption-Time |OC    |Used as defined in clause 7.2.             |
| Reporting-Reason       |-     |Not used in CCA.                           |
| Trigger                |Oc    |Used as defined in clause 7.2.             |
|  Trigger-Type          |OC    |Used as defined in clause 7.2.             |
|                        |OC    |Used as defined in clause 7.2.             |
|PS-Furnish-Charging-Info|      |                                           |
|rmation                 |      |                                           |
| Refund-Information     |OC    |Used as defined in clause 7.2.             |
|                        |-     |Not used in CCA.                           |
|AF-Correlation-Informati|      |                                           |
|on                      |      |                                           |
|                        |      |                                           |
| Envelope-Reporting     |OC    |Used as defined in clause 7.2.             |
| Time-Quota-Mechanism   |OC    |Used as defined in clause 7.2.             |
|  Time-Quota-Type       |M     |Used as defined in clause 7.2.             |
|  Base-Time-Interval    |M     |Used as defined in clause 7.2.             |
|                        |-     |Not used in CCA.                           |
|AF-Correlation-Informati|      |                                           |
|on                      |      |                                           |
| Service-Specific-Info  |-     |Not used in CCA.                           |
| QoS-Information        |-     |Not used in CCA.                           |
|                        |OC    |This field contains the Announcement       |
|Announcement-Information|      |service parameters. Each instance specifies|
|                        |      |a single announcement to be played to the  |
|                        |      |specified user.                            |
|                        |M     |This field contains a code identifying an  |
|Announcement-Identifier |      |announcement to be played.                 |
|  Variable-Part         |OC    |This field contains the parameters         |
|                        |      |necessary to define playback of a variable |
|                        |      |within the announcement.                   |
|   Variable-Part-Order  |OC    |This field identifies the order of the     |
|                        |      |variable to be played back.                |
|   Variable-Part-Type   |M     |This field identifies the type of the      |
|                        |      |variable to be played back.                |
|   Variable-Part-Value  |M     |This field identifies the value of the     |
|                        |      |variable to be played back.                |
|  Time-Indicator        |OC    |This field instructs the announcement to be|
|                        |      |connected at the specified time before     |
|                        |      |granted quota is exhausted.                |
|  Quota-Indicator       |OC    |This field indicates whether granted quota |
|                        |      |is to be used during announcement setup and|
|                        |      |playback.                                  |
|  Announcement-Order    |OC    |This field contains the order in which     |
|                        |      |announcements should be connected for      |
|                        |      |playback when there are multiple           |
|                        |      |announcements provided in a single message |
|                        |      |with the same timing indicator.            |
|  Play-Alternative      |OC    |This field indicates the call party toward |
|                        |      |whom an announcement is directed.          |
|                        |OC    |This field indicates whether the           |
|Privacy-Indicator       |      |announcement is considered private and is  |
|                        |      |only to be played to the requested party.  |
|  Language              |OC    |This field contains a code indicating the  |
|                        |      |language of the announcement that should be|
|                        |      |played.                                    |
|      3GPP-RAT-Type     |-     |Not used in CCA.                           |
|      Related-Trigger   |-     |Not used in CCA                            |
| AVP                    |-     |Not used in 3GPP.                          |
|Cost-Information        |OC    |Used as defined in DCCA [402].             |
| Unit-Value             |M     |Used as defined in DCCA [402].             |
|  Value-Digits          |M     |Used as defined in DCCA [402].             |
|  Exponent              |OC    |Used as defined in DCCA [402].             |
| Currency-Code          |M     |Used as defined in DCCA [402].             |
| Cost-Unit              |OC    |Used as defined in DCCA [402].             |
|Low-Balance-Indication  |Oc    |This field indicates whether the subscriber|
|                        |      |account balance went below a designated    |
|                        |      |threshold set by his account.              |
|Remaining-Balance       |OC    |This field contains the remaining balance  |
|                        |      |of the subscriber.                         |
| Unit-Value             |M     |Used as defined in DCCA  [402].            |
|  Value-Digits          |M     |Used as defined in DCCA  [402].            |
|  Exponent              |OC    |Used as defined in DCCA  [402].            |
| Currency-Code          |M     |Used as defined in DCCA  [402].            |
|Final-Unit-Indication   |-     |Not used in 3GPP, see                      |
|                        |      |Multiple-Services-Credit-Control.          |
| Final-Unit-Action      |-     |Not used in 3GPP.                          |
| Restriction-Filter-Rule|-     |Not used in 3GPP.                          |
| Filter-Id              |-     |Not used in 3GPP.                          |
| Redirect-Server        |-     |Not used in 3GPP.                          |
|  Redirect-Address-Type |-     |Not used in 3GPP.                          |
|                        |-     |Not used in 3GPP.                          |
|Redirect-Server-Address |      |                                           |
|Check-Balance-Result    |-     |Not used in 3GPP.                          |
|Credit-Control-Failure-H|OC    |Used as defined in DCCA [402].             |
|andling                 |      |                                           |
|Direct-Debiting-Failure-|OC    |Used as defined in DCCA [402].             |
|Handling                |      |                                           |
|Validity-Time           |-     |Not used in 3GPP.                          |
|OC-Supported-Features   |OC    |Used as defined in IETF 7683 [411], for    |
|                        |      |more details see clause B.                 |
|OC-Feature-Vector       |OC    |Used as defined in IETF 7683 [411], for    |
|                        |      |more details see clause B.                 |
|OC-OLR                  |OC    |Used as defined in IETF 7683 [411], for    |
|                        |      |more details see clause B.                 |
|Redirect-Host           |OC    |Used by redirect agent function as         |
|                        |      |specified in [401]. Contains the host the  |
|                        |      |request should be forwarded to.            |
|Redirect-Host-Usage     |OC    |Used by redirect agent function as         |
|                        |      |specified in [401]. Dictates how the       |
|                        |      |routing entry resulting from the           |
|                        |      |Redirect-Host is to be used.               |
|Redirect-Max-Cache-Time |OC    |Used by redirect agent function as         |
|                        |      |specified in [401]. Contains the maximum   |
|                        |      |number of seconds the peer and route table |
|                        |      |entries, created as a result of the        |
|                        |      |Redirect-Host, will be cached.             |
|Proxy-Info              |OC    |This field contains information of the     |
|                        |      |host.                                      |
| Proxy-Host             |M     |This field contains the identity of the    |
|                        |      |host that added the Proxy-Info field.      |
| Proxy-State            |M     |This field contains state local            |
|                        |      |information.                               |
|Route-Record            |OC    |This field contains an identifier inserted |
|                        |      |by a relaying or proxying node to identify |
|                        |      |the node it received the message from.     |
|Failed-AVP              |OC    |This field contains the AVP that could not |
|                        |      |be processed successfully. This field can  |
|                        |      |occur only once.                           |
|Service-Information     |OC    |This parameter holds the individual service|
|                        |      |specific parameters as defined in the      |
|                        |      |corresponding 'middle tier' TS.            |
|AVP                     |OC    |This field contains extended Information.  |




         6.4.4  Re-Auth-Request message

The DCCA RAR message format is defined according to the Diameter Base
Protocol in RFC 6733 [401] and DCCA specification in RFC 4006 [402]:

   <RAR> ::= < Diameter Header: 258, REQ, PXY >


           < Session-Id >
           { Origin-Host }
           { Origin-Realm }
           { Destination-Realm }
           { Destination-Host }
           { Auth-Application-Id }
           { Re-Auth-Request-Type }
           [ User-Name ]
           [ Origin-State-Id ]
           *[ Proxy-Info ]
           *[ Route-Record ]
           [ CC-Sub-Session-Id ]
           [ G-S-U-Pool-Identifier ]
           [ Service-Identifier ]
           [ Rating-Group ]
           *[ AVP ]


Table 6.4.4.1 illustrates the basic structure of a Diameter Credit-Control
Re-Auth-Request message as used for online charging.

           Table 6.4.4.1: RAR message contents for online charging

|AVP                     |Catego|Description                                |
|                        |ry    |                                           |
|Session-Id              |M     |This field identifies the operation        |
|                        |      |session.                                   |
|Origin-Host             |M     |This field contains the identification of  |
|                        |      |the source point of the operation and the  |
|                        |      |realm of the operation originator.         |
|Origin-Realm            |M     |This field contains the realm of the       |
|                        |      |operation originator.                      |
|Destination-Realm       |M     |This field contains the realm of the       |
|                        |      |operator domain. The realm will be         |
|                        |      |addressed with the domain address of the   |
|                        |      |corresponding public URI.                  |
|Destination-Host        |M     |This field contains the destination peer   |
|                        |      |address of the OCS identity.               |
|Auth-Application-Id     |M     |The field corresponds to the application ID|
|                        |      |of the Diameter Credit-Control Application |
|                        |      |and is defined with the value 4.           |
|Re-Auth-Request-Type    |M     |This field is used to inform the CTF of the|
|                        |      |action expected upon expiration of the     |
|                        |      |Authorization-Lifetime                     |
|User-Name               |OC    |This field contains the username.          |
|Origin-State-Id         |OC    |This field contains the state associated to|
|                        |      |the CTF.                                   |
|Proxy-Info              |OC    |This field contains information of the     |
|                        |      |host.                                      |
| Proxy-Host             |M     |This field contains the identity of the    |
|                        |      |host that added the Proxy-Info field.      |
| Proxy-State            |M     |This field contains state local            |
|                        |      |information.                               |
|Route-Record            |OC    |This field contains an identifier inserted |
|                        |      |by a relaying or proxying node to identify |
|                        |      |the node it received the message from.     |
|CC-Sub-Session-Id       |-     |Not used in 3GPP.                          |
|G-S-U-Pool-Identifier   |OC    |This field contains an identifier to       |
|                        |      |indicate the credit pool.                  |
|Service-Identifier      |OC    |This field contains identity of the used   |
|                        |      |service. This ID with the                  |
|                        |      |Service-Context-ID together forms an unique|
|                        |      |identification of the service.             |
|Rating-Group            |OC    |This field contains the identifier of a    |
|                        |      |rating group.                              |
|AVP                     |OC    |This field contains extended Information.  |




         6.4.5  Re-Auth-Answer message

The DCCA RAA message format is defined according to the Diameter Base
Protocol in RFC 6733 [401] and DCCA specification in RFC 4006 [402]:

   <RAA> ::= < Diameter Header: 258, PXY >


           < Session-Id >
           { Result-Code }
           { Origin-Host }
           { Origin-Realm }
           [ User-Name ]
           [ Origin-State-Id ]
           [ Error-Message ]
           [ Error-Reporting-Host ]
            [ Failed-AVP ]
           *[ Redirect-Host ]
           [ Redirect-Host-Usage ]
           [ Redirect-Host-Cache-Time ]
           *[ Proxy-Info ]
           [ CC-Sub-Session-Id ]
           [ G-S-U-Pool-Identifier ]
           [ Service-Identifier ]
           [ Rating-Group ]
           *[ AVP ]


Table 6.4.5.1 illustrates the basic structure of a Diameter Credit-Control
Re-Auth-Answer message as used for online charging.

           Table 6.4.5.1: RAA message contents for online charging

|AVP                   |Category |Description                               |
|Session-Id            |M        |This field identifies the operation       |
|                      |         |session.                                  |
|Result-Code           |M        |This field contains the result of the     |
|                      |         |specific query.                           |
|Origin-Host           |M        |This field contains the identification of |
|                      |         |the source point of the operation and the |
|                      |         |realm of the operation originator.        |
|Origin-Realm          |M        |This field contains the realm of the      |
|                      |         |operation originator.                     |
|User-Name             |OC       |This field contains the username.         |
|Origin-State-Id       |OC       |This field contains the state associated  |
|                      |         |to the source point of the operation.     |
|Error-Message         |OC       |This field contains a human readable error|
|                      |         |message.                                  |
|Error-Reporting-Host  |OC       |This field contains the identity of the   |
|                      |         |Diameter host that sent the Result-Code   |
|                      |         |AVP to a value other than 2001 (Success)  |
|                      |         |if the host setting the Result-Code is    |
|                      |         |different from the one encoded in the     |
|                      |         |Origin-Host AVP.                          |
|Failed-AVP            |OC       |This field contains the AVP that could not|
|                      |         |be processed sucessfully. This field can  |
|                      |         |occur only once.                          |
|Redirect-Host         |OC       |Used by redirect agent function as        |
|                      |         |specified in [401]. Contains the host the |
|                      |         |request should be forwarded to.           |
|Redirect-Host-Usage   |OC       |Used by redirect agent function as        |
|                      |         |specified in [401]. Dictates how the      |
|                      |         |routing entry resulting from the          |
|                      |         |Redirect-Host is to be used.              |
|Redirect-Max-Cache-Tim|OC       |Used by redirect agent function as        |
|e                     |         |specified in [401]. Contains the maximum  |
|                      |         |number of seconds the peer and route table|
|                      |         |entries, created as a result of the       |
|                      |         |Redirect-Host, will be cached.            |
|Proxy-Info            |OC       |This field contains information of the    |
|                      |         |host.                                     |
| Proxy-Host           |M        |This field contains the identity of the   |
|                      |         |host that added the Proxy-Info field.     |
| Proxy-State          |M        |This field contains state local           |
|                      |         |information.                              |
|CC-Sub-Session-Id     |-        |Not used in 3GPP.                         |
|G-S-U-Pool-Identifier |-        |Not used in 3GPP.                         |
|Service-Identifier    |-        |Not used in 3GPP.                         |
|Rating-Group          |-        |Not used in 3GPP.                         |
|AVP                   |OC       |This field contains extended Information. |



6.4.6  Capabilities-Exchange-Request message

The Capabilities-Exchange-Request message structure shall be as specified
in RFC 6733 [401] clause 5.3.1.

6.4.7  Capabilities-Exchange-Answer message

The Capabilities-Exchange-Answer message structure shall be as specified in
RFC 6733 [401] clause 5.3.2.

6.4.8  Device-Watchdog-Request message

The Device-Watchdog-Request message structure shall be as specified in RFC
6733 [401] clause 5.5.1.

6.4.9  Device-Watchdog-Answer message

The Device-Watchdog-Answer message structure shall be as specified in RFC
6733 [401] clause 5.5.2.

6.4.10 Disconnect-Peer-Request message

The Disconnect-Peer-Request message structure shall be as specified in RFC
6733 [401] clause 5.4.1.

6.4.11 Disconnect-Peer-Answer message

The Disconnect-Peer-Answer message structure shall be as specified in RFC
6733 [401] clause 5.4.2.

6.4.12 Abort-Session-Request message

The Abort-Session-Request message structure shall be as specified in RFC
6733 [401] clause 8.5.1.

6.4.13 Abort-Session -Answer message

The Abort-Session-Answer message structure shall be as specified in RFC
6733 [401] clause 8.5.2.

         6.5  Other procedural description of the 3GPP charging applications


6.5.1  Re-Authorization


6.5.1.1  Idle timeout

The server may specify an idle timeout associated with a granted quota
using the Quota-Holding-Time AVP.
If no traffic associated with the quota is observed for this time, the
client shall understand that the traffic has stopped and the quota is
returned to the server. The client shall start the quota holding timer when
quota consumption ceases.  This is always when traffic ceases, i.e. the
timer is re-started at the end of each packet. It applies equally to the
granted time quota and to the granted volume quota. The timer is stopped on
sending a CCR and re-initialised on receiving a CCA with the previous used
value or a new value of Quota-Holding-Time AVP if received.

Alternatively, if this AVP is not present, a locally configurable default
value in the client shall be used.
A Quota-Holding-Time AVP value of zero indicates that this mechanism shall
not be used.


6.5.1.2  Change of charging conditions

There are a number of mid-session service events (re-authorization
triggers), which could affect the rating of the current service usage, e.g.
end user QoS changes or location updates. When allocating resources, the
server may instruct the Credit-Control client to re-authorize the quota
upon a number of different session related triggers that can affect the
rating conditions. The server instruct the Network Element to monitor for
such events by using the Trigger AVP containing one or more Trigger-Type
AVPs in the CCA command. These events are in addition to the static
triggers defined in the service specific document (middle tier TS).

Once the OCS has armed one or more triggers using the Trigger AVP at the
Network Element, these triggers shall remain in effect until another
Trigger AVP is received for the same Rating Group, where the Network
Element shall arm all triggers present in the Trigger AVP and reset all
other triggers. The presence of the Trigger AVP without any Trigger-Type
AVPs in a CCA allows OCS to disable all the triggers that were armed in a
previous Trigger AVP.

  NOTE:  This removes the need for the OCS to send trigger information in
         every CCA message when they have not changed.

When one of the armed triggers happen, a credit re-authorization shall be
sent to the server including information related to the service event even
if all the granted service units have not been used. The quota is also
being reported.

For example, if the Trigger AVP is used, then the client shall only re-
authorize the quota for the service usage associated with  events which
were included in the last received Trigger AVP.

If the server does not control the events for re-authorization using the
Trigger AVP, the Network Element shall only monitor for default events
defined in the relevant service specific document (middle tier TS).


6.5.1.3  Reporting quota usage

The Credit-Control client shall report the quota usage under a number of
circumstances. When this happens, the reason for the quota being reported
is notified to the server through the use of the Reporting-Reason AVP in
the CCR. The reason for reporting credit usage can occur directly in the
Multiple-Services-Credit-Control AVP, or in the Used-Service-Units AVP,
depending on whether it applies for all quota types or a particular quota
type respectively. It shall not be used at command level.  It shall always
and shall only be sent when usage is being reported.

When the reason is RATING_CONDITION_CHANGE, the Trigger AVP shall also be
included to indicate the specific armed trigger events which caused the
reporting and re-authorization request.



           6.5.1.4  Quota consumption

The consumption of quota is captured using mechanisms described in clause
6.5.1.3.

Volume quota is considered used or consumed in the normal way,
corresponding to actual traffic.

The consumption of time quota may be controlled by Quota-Consumption-Time
as described in clause 6.5.4, or by extended mechanisms as described in
clause 6.5.7.


6.5.2  Threshold based Re-Authorization triggers

The server may optionally include as part of the Multiple-Services-Credit-
Control AVP, when it is providing a quota, an indication to the client of
the remaining quota threshold that shall trigger a quota re-authorization.
The Time-Quota-Threshold AVP indicates the threshold in seconds when the
granted quota is time, and the Volume-Quota-Threshold AVP indicates the
threshold in octets when the granted quota is volume.
The Unit-Quota-Threshold AVP indicates the threshold in service specific
units, that are defined in the service specific documents, when the granted
quota is service specific.

If the threshold triggers were included along with the quota granted, the
Credit-Control client, then, shall seek re-authorization from the server
for the quota when the quota contents fall below the supplied threshold.
The client shall allow service to continue whilst the re-authorization is
progress, until the original quota had been consumed.


6.5.3  Termination action

The termination action is sent over the Ro reference point. Two different
approaches are specified:

-  The Final-Unit-Indication AVP with Final-Unit-Action TERMINATE does not
    include any other information. When the user has consumed the final
    granted units or zero quota has been granted by the OCS, the Network
    Element shall terminate the service. This is the default handling
    applicable whenever the client receives an unsupported Final-Unit-
    Action value. The Network Element shall send CCR message with CC-
    Request-Type AVP  set to the value UPDATE_REQUEST and report the Used-
    Service-Unit AVP for the service that has terminated, as defined in RFC
    4006 [402].

-  Another termination action consists in re-directing packets
    corresponding to a terminated service (consumption of the final granted
    units or zero quota has been granted by the OCS) to an application
    server. This allows the client to redirect user originated requests to
    a top-up server so that network access can be re-instated. This
    functionality is achieved with the server returning a "REDIRECT" and
    redirect-to URL in the Final-Units-Action AVP of the Multiple-Services-
    Credit-Control AVP. Upon receiving this result code, the Network
    Element shall apply the redirection. The URL should be categorized so
    that the End-User's ability to reach it is guaranteed.

When zero quota has been granted by the OCS, the termination action shall
be enforced at the reception of the CCA message.



         6.5.4  Quota consumption time

The server may optionally indicate to the client that the quota consumption
shall be stopped after a period equal to the Quota Consumption Time in
which no packets are received or at session termination, whichever is
sooner. This is indicated by including the Quota-Consumption-Time AVP in
the CCA. The idle period equal to the Quota Consumption Time is included in
the reported usage. The quota is consumed normally during gaps in traffic
of duration less than or equal to the Quota-Consumption-Time. Quota
consumption resumes on receipt of a further packet belonging to the service
data flow.

If packets are allowed to flow during a CCR/CCA[Update] exchange, and the
Quota-Consumption-Time AVP value in the provided quota is the same as in
the previously provided quota, then the Quota-Consumption-Time runs
normally through this procedure. For example, if 5 seconds of a 10 second
QCT timer have passed when a CCR[Update] is triggered, and the CCA[Update]
returns 2 seconds later, then the QCT timer will expire 3 seconds after the
receipt of the CCA and the remaining unaccounted 5 seconds of usage will be
recorded against the new quota even though no packets were transmitted with
the new quota.

In the case of a new quota with the Quota-Consumption-Time AVP, or when
packets are blocked during the CCR/CCA [Update] procedure then the Quota-
Consumption-Time stops running (if it was running) and quota consumption
begins again when the next service data flow packet matching the Charging
Rule is received.

If a Quota-Consumption-Time AVP value of zero is provided, or if no Quota-
Consumption-Time AVP is present in the CCA, the quota is consumed
continuously from the point at which it is granted.


6.5.5  Service termination

The OCF may determine that a service requires termination. The OCF may
perform this termination synchronously if it has a CCR pending processing
by returning CCA with Result-Code AVP with value DIAMETER-AUTHORIZATION-
REJECTED. If the OCF does not have a pending request (asynchronous), the
OCF may trigger an ASR to terminate the Diameter session related to the
service. On reception of an ASR, the CTF shall close the associated Credit-
Control session by sending a CCR [Terminate]. The behaviour of the CTF, in
relation to the user session, on reception of an ASR is detailed in the
middle-tier TS. As an alternative to the ASR, the OCF may trigger a RAR to
which the CTF behaves as described in RFC 4006 [402] and the OCF shall
return a CCA with Result-Code AVP with value DIAMETER-AUTHORIZATION-
REJECTED for the resulting CCR.


6.5.6  Envelope reporting


6.5.6.1  Envelope reporting in Online Charging

The OCF may determine the need for additional detailed reports identifying
start time and end times of specific activity in addition to the standard
quota management provided in RFC 4006 [402]. The OCF controls this by
sending a CCA[INITIAL] with Envelope-Reporting AVP. The OCF may request
reports for just time, time and volume, time and number of events, or time
and volume and number of events, through appropriate values in Envelope-
Reporting AVP.

The time envelope of the activity to be reported is determined by the
mechanism indicated by the OCF in this CCA[INITIAL], to control the time
quota consumption in the CTF.

The selected mechanism is used by the CTF to generate the envelopes,
reporting the start and end of each time envelope, and the data volume
transferred and / or the number of events that occurred for the duration of
the envelope

  NOTE:  Envelope reporting is independent of quota management (i.e. there
         is no interaction).


6.5.6.2  Envelope reporting in Offline Charging

When a particular time quota consumption mechanism is selected by the OCF,
the need for reporting detailed time envelopes in offline charging, may be
statically configured in the CTF or dynamically controlled by the OCF using
Offline-Charging AVP.

The selected time quota consumption mechanism is used by the CTF to
generate the envelopes, reporting the start and end of each time envelope,
and the data volume transferred and / or the number of events that occurred
for the duration of the envelope.


6.5.6.3  Envelope reporting - Quota consumption time

In case the time quota consumption mechanism selected by the OCF is per
clause 6.5.4, and the OCF indicated the need for envelope reporting,.the
CTF, on receiving the command, monitors the traffic for a period of time
controlled by the Quota-Consumption-Time AVP and reports each period as a
single envelope for each Quota-Consumption-Time expiry where there was
traffic, in Envelope AVP.


6.5.6.4  Envelope reporting - Combinational quota

In case the time quota consumption mechanism selected by the OCF is per
clause 6.5.7, and the OCF indicated the need for envelope reporting, the
CTF, on receiving the command, monitors the traffic based on information
included in Time-Quota-Mechanism AVP, and reports each corresponding
envelope in the Envelope AVP in the CCR.

In case of Continuous Time Period (CTP):

  -  the first envelope starts on the first traffic, and subsequent
    envelopes start on the first traffic following the closure of the
    previous envelope.

  -  each envelope ends at expiry of the first base time interval which
    contains no traffic.

The envelope for CTP includes the last base time interval, i.e. the one
which contained no traffic. The end of an envelope can only be determined
"retrospectively".

In case of Discrete Time Period (DTP), an envelope corresponds to exactly
one base time interval.



         6.5.7  Combinational quota

The Quota-Consumption-Time mechanism, described in clause 6.5.4, may be
extended (and replaced) when granting time based quota to provide
potentially more efficient use of the online charging interface, i.e.
reduced traffic and the algorithms in the OCF are potentially simpler. The
alternative handling mechanisms that are defined in this clause are:

  1. Continuous Time Period (CTP)

  2. Discrete Time Period (DTP)

The mechanisms selected by the OCF is indicated to the CTF with the Time-
Quota-Mechanism AVP in the CCA.

The base time interval, specified by the Base-Time-Interval AVP, is a basic
unit for consuming quota. Quota is deemed to be consumed at the start of
each base time interval. The CTF shall allow traffic to pass for the
duration of the base time interval.

For DTP, the base time interval defines the length of the discrete time
period. Quota consumption resumes only on the first traffic following the
expiry of the DTP.

For CTP, quota consumption continues during consecutive base time intervals
in which traffic has occurred up to and including the first base time
interval which contains no traffic. Quota consumption shall be stopped
after this first base time interval expiry which contained no traffic.
Quota consumption resumes only on the first subsequent traffic.

If the CTF receives a Multiple-Services-Credit-Control AVP with both the
Quota-Consumption-Time AVP and Time-Quota-Mechanism AVP, then the Time-
Quota-Mechanism AVP takes precedence and the CTF shall behave accordingly.


6.5.8  Online control of offline charging information

The Offline-Charging AVP is used on the Ro interface by the OCS to control
the CTF in relation to the mechanism by which the CTF generates offline
charging information, e.g. for flow based charging controls the formation
of service data containers. The information contained, within the Offline-
Charging AVP, takes precedence over the default configuration at the CTF.
If the Offline-Charging AVP is not sent in the CCA, the OCS does not
control the offline charging mechanisms and therefore the default
configuration at the CTF is employed.

Controls over time usage, defined in clause 6.5.6 and clause 6.5.7, are
included.


6.5.9  Support of multiple service

The support of multiple services within a single Diameter session in 3GPP
is limited to services that are grouped in one of the middle tier TSs
specified through the Service-Context-Id AVP.


6.5.10 Supported Features mechanism


6.5.10.1 Introduction

Supported Features mechanism is used for 3GPP Charging Applications as
specified in TS 29.229 [204] clause 7.2, based on the Supported-Features
AVP.


6.5.10.2 Defining a feature

The concept of feature used by the Supported Features mechanism, applies
under a specific domain / subsystem / service, and is defined as an
extension of the base offline and online charging functionality specified
in the corresponding middle tier.

For each middle tier, the base functionality is the one specified by the
3GPP Rel-14 version, and for any extension introduced from Rel-15, the
Supported Features mechanism is required.

For any middle tier created from Rel-15, the Supported Features mechanism
is required to be introduced.

Applicability of a feature is defined separately between offline (Rf) and
online(Ro) charging.

Any feature specified for offline and online charging, when invoked by the
client, is defined as mandatory to be supported by the server.

As specified in TS 29.229 [204] clause 7.1.1, if new AVPs are added as part
of the feature definition, they shall have the 'M' bit cleared and shall
not be defined mandatory in the command ABNF.


6.5.10.3 Supported Feature handling

Any request initiated by the client which makes use of a feature to
construct the request, and requires the feature to be supported by the
server, shall include the feature associated to the service-context in the
Supported-Features AVP.

The client shall include in the request feature(s) and only feature(s)
which are needed to construct the request.

In case multiple features are needed to construct the request, they shall
all be included by the client.

As defined in TS 29.229 [204], the Supported-Features AVP is of type
grouped and contains the Vendor-Id, Feature-List-ID and Feature-List AVPs.

The value 10415 (3GPP) is used as Vendor-Id, and the Feature-List-ID and
Feature-List are defined per middle tier TS.

Upon receiving any initial Ro or Rf request for a specific domain /
subsystem / service, which does not include any Supported-Features AVP, the
server shall include in the answer, if supported, Supported-Features AVPs
identifying the complete set of features supported by the server for this
domain / subsystem / service. This applies regardless of the answer is
successful or not.

Upon receiving any initial Ro or Rf request for a specific domain /
subsystem / service, which includes the Supported-Features AVP, the server
shall behave as follows:

  -  If all features indicated in the Supported-Features AVP are supported,
    and the process for online or offline charging is successful, a
    successful answer with the Result-Code AVP set to DIAMETER_SUCCESS is
    returned and includes, if supported, Supported-Features AVPs
    identifying the complete set of features supported by the server for
    this domain / subsystem / service.

  -  If not all the features indicated in the Supported-Features AVP are
    supported, the answer is returned with Experimental-Result-Code AVP set
    to DIAMETER_ERROR_FEATURE_UNSUPPORTED and includes the Supported-
    Features AVPs containing lists of all features supported by the server.



  -  If Supported-Features AVP is not supported by the server, the answer
    is returned, as per 'M' bit set rule, with the Result-Code AVP set to
    DIAMETER_AVP_UNSUPPORTED and a Failed-AVP AVP containing at least one
    Supported-Features AVP as received in the request.

During the lifetime of the Diameter session, the client shall use the set
of features which are common between its own set of supported features and
the set of supported features indicated by the server during the Diameter
session establishment, in session based charging.




         6.6  Bindings of the operation to protocol application


6.6.0  General

This clause aims to describe the mapping between the protocol independent
messages and parameter with the Diameter messages and AVP utilized on the
3GPP offline and online charging.


6.6.1  Bindings of Charging Data Transfer to Accounting

Table 6.6.1.1 describes the bindings of the Charging Data Transfer
operation parameter to the DBPA AVP for 3GPP offline charging.

                    Table 6.6.1.1: Bindings to Accounting

|Charging Data Transfer  |Diameter Accounting AVP       |
|element                 |                              |
|Operation Number        |Accounting-Record-Number      |
|Operation Type          |Accounting-Record-Type        |
|Operation Identifier    |Acct-Application-Id           |
|Operation Interval      |Acct-Interim-Interval         |
|Destination Domain      |Destination-Realm             |
|Error Reporting Host    |Error-Reporting-Host          |
|Origination Timestamp   |Event-Timestamp               |
|Originator Host         |Origin-Host                   |
|Originator Domain       |Origin-Realm                  |
|Origination State       |Origin-State-Id               |
|Proxy Information       |Proxy-Info                    |
|Operation Result        |Result-Code                   |
|Route Information       |Route-Record                  |
|Service Information     |Service-Information           |
|Session Identifier      |Session-Id                    |
|Operation Token         |Service-Context-Id            |
|User Name               |User-Name                     |




         6.6.2  Bindings of Debit / Reserve Units to Credit-Control

Table 6.6.2.1 describes the bindings of the Debit / Reserve Units operation
parameter to the DCCA AVP for 3GPP 0nline charging.

                  Table 6.6.2.1: Bindings to Credit-Control

|Debit / Reserve Units   |DCCA AVP                       |
|element                 |                               |
|AoC Type                |AoC-Request-Type               |
|Cost Information        |Cost-Information               |
|Destination Domain      |Destination-Realm              |
|Destination Host        |Destination-Host               |
|Failed parameter        |Failed-AVP                     |
|Low Balance Indication  |Low-Balance-Indication         |
|Multiple Operation      |Multiple-Services-Indicator    |
|Multiple Unit Operation |Multiple-Services-Credit-Contro|
|                        |l                              |
|Operation Correlation   |CC-Correlation-Id              |
|Operation Failover      |CC-Session-Failover            |
|Operation Failure Action|Credit-Control-Failure-Handling|
|Operation Identifier    |Auth-Application-Id            |
|Operation Number        |CC-Request-Number              |
|Operation Result        |Result-Code                    |
|Operation Token         |Service-Context-Id             |
|Operation Type          |CC-Request-Type                |
|Origination State       |Origin-State-Id                |
|Origination Timestamp   |Event-Timestamp                |
|Originator Domain       |Origin-Realm                   |
|Originator Host         |Origin-Host                    |
|Proxy Information       |Proxy-Info                     |
|Redirection Cache Time  |Redirect-Max-Cache-Time        |
|Redirection Host        |Redirect-Host                  |
|Redirection Host Usage  |Redirect-Host-Usage            |
|Remaining Balance       |Remaining-Balance              |
|Requested Action        |Requested-Action               |
|Route Information       |Route-Record                   |
|Service Information     |Service-Information            |
|Session Identifier      |Session-Id                     |
|Subscriber Equipment    |User-Equipment-Info            |
|Number                  |                               |
|Subscriber Identifier   |Subscription-Id                |
|Termination Cause       |Termination-Cause              |
|User Name               |User-Name                      |



6.7  Securing Diameter messages

For secure transport of Diameter messages used for offline and online
charging application, see 3GPP TS 33.210 [246].



         7  Summary of used Attribute Value Pairs


7.1  Diameter AVPs


7.1.0  General

The use of the Attribute Value Pairs (AVPs) that are defined in the
Diameter Protocol is specified in clause 6.2 for offline charging and in
clause 6.4 for online charging. The information is summarized in the table
7.1.0.1 in alphabetical order. Detailed specification of some of these AVPs
is available after the table and for the others can be found from RFC 6733
[401], RFC 4006 [402] and RFC 4005 [407].

Those Diameter AVPs that are used are marked "M", "OM" or "Oc" in the
following table.
This implies that their content can be used by the CDF for offline and by
the OCF for online charging purposes.
Those Diameter AVPs that are not used are marked "-" in table 7.1.0.1.

                  Table 7.1.0.1: Use Of IETF Diameter AVPs

|AVP Name              |AVP|Used in        |Value   |AVP Flag rules   |
|                      |   |               |Type    |                 |
|                      |Cod|               |        |                 |
|                      |e  |               |        |                 |
|                     |     |ACR             |ACA       |CCR            |
|       |                                      |
|Integer|String of digits, which shall be      |
|       |announced as a single number, up to 10|
|       |digits.                               |
|Number |String of digits, which shall be      |
|       |announced as individual digits, up to |
|       |24 digits.                            |
|Time   |A string of digits in the form HHMM.  |
|Date   |A string of digits in the form of     |
|       |YYYYMMDD.                             |
|Currenc|A string of digits in the form of     |
|y      |AAAAAABB, where AAAAAA is the integral|
|       |part and BB is the decimal part.      |



7.2.242A VCS-Information AVP

The VCS-Information AVP (AVP code 3410) is of type Grouped. Its purpose is
to allow the transmission of additional VCS service specific information
elements.

It has the following ABNF grammar:

       VCS-Information :: =     < AVP Header: 3410>

                       [ Bearer-Capability ]
                       [ Network-Call-Reference-Number ]
                       [ MSC-Address ]
                       [ Basic-Service-Code ]
                       [ ISUP-Location-Number ]
                       [ VLR-Number ]
                       [ Forwarding-Pending ]
                       [ ISUP-Cause ]
                       [ Start-Time ]
                       [ Start-of-Charging ]
                       [ Stop-Time ]
                       [ PS-Free-Format-Data ]


7.2.242B VLR-Number AVP

The VLR-Number AVP (AVP code 3420) is type OctetString and identifies the
international E.164 address of the VLR serving the user. It is encoded as a
TBCD-string. See TS 29.002 [232] for encoding of TBCD-strings.
This AVP does not include leading indicators for the nature of address and
the numbering plan; it contains only the TBCD-encoded digits of the
address.


7.2.243  Volume-Quota-Threshold AVP

The Volume-Quota-Threshold AVP (AVP code 869) is of type Unsigned32 and
contains a threshold value in octets. This AVP may be included within the
Multiple-Services-Credit-Control AVP when this AVP also contains a Granted-
Service-Units AVP containing a CC-Total-Octets AVP, CC-Input-Octets AVP or
CC-Output-Octets AVP (i.e. when the granted quota is a volume quota).

If received, the Credit-Control client shall seek re-authorization from the
server for the quota when the quota contents fall below the supplied
threshold. The client shall allow service to continue whilst the re-
authorization is progress, up to the volume indicated in the original
quota.


7.2.244  Void




7.2.245  Void




7.2.246  Void




7.2.247  Void




7.2.248  Void




7.2.249  Void




7.2.250  Void


7.2.251  WLAN-Operator-Id AVP

The WLAN-Operator-Id AVP (AVP code 1306) is of type Grouped and holds the
identity of the trusted or untrusted WLAN Operator.

    WLAN-Operator-Id :: =  < AVP Header: 1306>

                        [ WLAN-PLMN-Id ]
                        [ WLAN-Operator-Name ]



7.2.252  WLAN-Operator-Name AVP

The WLAN-Operator-Name AVP (AVP code 1307) is of type UTF8String and holds
the Name of the trusted or untrusted WLAN Operator, as specified in
subclause 19. 8 of 3GPP TS 23.003 [224].




7.2.253  WLAN-PLMN-Id AVP

The WLAN-PLMN-Id AVP (AVP code 1308) is of type UTF8String and holds the
PLMN Identity of the trusted or untrusted WLAN Operator.





         7.3  3GPP2 specific AVPs

For the purpose of offline and online charging, the use of the AVPs defined
for 3GPP2 Access is provided in table 7.3.1, and the specification
including the detailed definition and description, is referred to.

These AVPs shall be used together with value 5535 (3GPP2) as Vendor-Id.



                      Table 7.3.1: 3GPP2 specific AVPs

|AVP Name   |AVP  |Used in            |         |
|           |Code |                   |Reference|
|                |    |ACR               |ACA     |
|                |    |ACR               |ACA     |
|                                                                            |
|Date                                                                      |


 Date |Meeting |TDoc |CR |Rev |Cat |Subject/Comment |New version | |2016-06
|SA#72 |SP-160416 |0719 |1 |F |Correction of cell information received with
   untrusted WLAN access information – alignment with TS 24.229 |13.5.0 |
|2016-06 |SA#72 |SP-160416 |0720 |- |F |Correction to align AVP code for
  UWAN-User-Location-Info in ABNF with table |13.5.0 | |2016-06 |SA#72 |SP-
 160412 |0721 |1 |F |Correction for the AVP codes for MONTE charging |13.5.0
| |2016-06 |SA#72 |SP-160420 |0724 |- |B |Completion of access change of
 service data flow for NBIFOM |13.5.0 | |2016-06 |SA#72 |SP-160420 |0725 |1
 |B |Completion of change of charging condition for NBIFOM |13.5.0 | |2016-
06 |SA#72 |SP-160411 |0726 |3 |B |Introduce CP data transfer Rf offline
charging |13.5.0 | |2016-06 |SA#72 |SP-160411 |0734 |1 |B |Introduce non-IP
  PDN and CP CIoT opt in Rf offline charging |13.5.0 | |2016-06 |SA#72 |SP-
160417 |0732 |1 |F |Correction on the AoC-Information AVP and Terminal-
Information AVP |14.0.0 | |2016-09 |SA#73 |SP-160623 |0736 |1 |B
  |Complement of Charging per IP-CAN Session |14.1.0 | |2016-09 |SA#73 |SP-
160621 |0739 |1 |F |Introduction of allocated AVPs code ranges - alignement
with 29.230 |14.1.0 | |2016-09 |SA#73 |SP-160621 |0740 |1 |A |Correction of
    trigger conditions description for NIDD submission |14.1.0 | |2016-09
|SA#73 |SP-160621 |0741 |1 |A |Correction on AVP Code for Serving PLMN Rate
Control - alignement with 29.230 |14.1.0 | |2016-09 |SA#73 |SP-160621 |0742
 |1 |A |Correction on APN Rate Control - Alignment with TS 23.401   |14.1.0
| |2016-09 |SA#73 |SP-160621 |0745 |- |A |Correction on Control Plane CIoT
 EPS Optimisation Indicator in PGW - alignement with 23.401 |14.1.0 | |2016-
09 |SA#73 |SP-160621 |0746 |- |A |Correction on "MO exception data" RRC
 establishment cause in offline charging – alignement with TS 23.401 |14.1.0
| |2016-12 |SA#74 |SP-160845 |0752 |1 |A |Correction on Requested Party
Address for Emergency IMS session |14.2.0 | |2016-12 |SA#74 |SP-160851
|0754 |- |A |Correction on duplicate values for Change-Condition |14.2.0 |
|2016-12 |SA#74 |SP-160847 |0755 |1 |F |Correction on Access Network Info
change with the time in offline |14.2.0 | |2016-12 |SA#74 |SP-160847 |0756
    |1 |F |Correction on Role-Of-node for AS serving the forwarding party
|14.2.0 | |2016-12 |SA#74 |SP-160847 |0757 |1 |F |Correction of Number-
Portability-Routing-Information |14.2.0 | |2016-12 |SA#74 |SP-160847 |0758
    |1 |F |Correction of Called-Party-Address and Requested-Party-Address
|14.2.0 | |2016-12 |SA#74 |SP-160847 |0759 |1 |F |Correction of Change-Time
to include Access Transfer Time |14.2.0 | |2017-03 |SA#75 |SP-170144 |0760
 |1 |B |Charging enhancement for 3GPP PS Data off |14.3.0 | |2017-03 |SA#75
|SP-170133 |0761 |1 |B |Addition of the fields for ProSe Charging |14.3.0 |
|2017-03 |SA#75 |SP-170129 |0762 |1 |B |Addition of multiple PRAs support
for AULC |14.3.0 | |2017-03 |SA#75 |SP-170137 |0764 |1 |A |Correction on
 the APN Rate Control and SCS/AS Address AVP |14.3.0 | |2017-03 |SA#75 |SP-
  170136 |0770 |1 |A |Correction removal of Redirect-Address-Type from CCR
|14.3.0 | |2017-03 |SA#75 |SP-170138 |0771 |1 |B |Replace reference to RFC
3588 by RFC 6733 |14.3.0 | |2017-03 |SA#75 |SP-170138 |0772 |1 |B
 |Introduce clause for Diameter transport security |14.3.0 | |2017-03 |SA#75
   |SP-170138 |0773 |1 |B |New Command CCF in RFC 6733 |14.3.0 | |2017-03
|SA#75 |SP-170138 |0774 |- |B |Remove "encr" and 'P' flag description in
AVPs tables |14.3.0 | |2017-03 |SA#75 |SP-170134 |0775 |- |B |Adding
   Reporting-Reason for Unused Quota timer |14.3.0 | |2017-06 |SA#76 |SP-
    170498 |0776 |1 |B |Implement IMS visited network identifier for S8HR
|14.4.0 | |2017-06 |SA#76 |SP-170497 |0777 |1 |F |Correction on the
description of AVPs |14.4.0 | |2017-06 |SA#76 |SP-170495 |0780 |1 |B
|Adding of Unused-Quota-Timer to CCA |14.4.0 | |2017-06 |SA#76 |SP-170503
 |0782 |- |A |Correction of ISUP Cause naming |14.4.0 | |2017-06 |SA#76 |SP-
 170500 |0783 |- |B |Introduce T4 Device Trigger charging  |14.4.0 | |2017-
06 |SA#76 |SP-170500 |0784 |- |B |Introduce MSISDN-less SMS MO via T4
charging |14.4.0 | |2017-06 |SA#76 |SP-170514 |0785 |1 |F |Correction of
 IMEI and IMEISV definition |14.4.0 | |2017-06 |SA#76 |SP-170497 |0786 |1 |B
|Addition of the AVPs for ProSe Discovery and Communication |14.4.0 | |2017-
  06 |SA#76 |SP-170506 |0787 |1 |B |Introduction of FE Identifier List AVP
|14.4.0 | |2017-09 |SA#77 |SP-170653 |0788 |1 |F |Clarification on Envelope
reporting |14.5.0 | |2017-09 |SA#77 |SP-170650 |0789 |1 |B |Charging
enhancement for eFMSS |15.0.0 | |2018-01 |SA#78 |SP-171005 |0792 |- |A
  |Correction where RAN-NAS-Release-Cause is defined as a squence |15.1.0 |
|2018-01 |SA#78 |SP-170965 |0793 |- |C |PoC-Server-Role AVP extension for
OMA CPM Charging |15.1.0 | |2018-01 |SA#78 |SP-170966 |0794 |1 |B |EPC QoS
   update to support NR as a secondary RAT |15.1.0 | |2018-03 |SA#79 |SP-
180068 |0796 |1 |B |Add Diameter AVP for charging of WLAN-based ProSe
direct discovery |15.2.0 | |2018-03 |SA#79 |SP-180062 |0798 |1 |B |Support
for secondary RAT reporting from RAN |15.2.0 | |2018-06 |SA#80 |SP-180430
 |0799 |2 |B |Introduce the NAPS API Charging |15.3.0 | |2018-06 |SA#80 |SP-
180427 |0800 |1 |B |Enhance location information in trusted and untrusted
WLAN |15.3.0 | |2018-06 |SA#80 |SP-180429 |0801 |- |F |Correction Access-
  Network-Info-Change only applicable for Rf |15.3.0 | |2018-06 |SA#80 |SP-
180432 |0803 |1 |B |Adding General information for Diameter Overload
Control |15.3.0 | |2018-06 |SA#80 |SP-180426 |0804 |1 |B |Introduce IMS
over 5GS |15.3.0 | |2018-06 |SA#80 |SP-180428 |0805 |1 |B |Introduce
  Supported Feature mechanism |15.3.0 | |2018-06 |SA#80 |SP-180428 |0806 |1
  |B |Introduce Supported Feature mechanism AVPs |15.3.0 | |2018-06 |SA#80
    |SP-180428 |0807 |- |B |Introduce Supported Features for PS and ProSe
|15.3.0 | |2018-06 |SA#80 |SP-180427 |0808 |1 |B |Enhance UE location
 description for IMS charging when over WLAN |15.3.0 | |2018-09 |SA#81 |SP-
 180834 |0809 |- |F |Update the value of secondary RAT type |15.4.0 | |2018-
09 |SA#81 |SP-180834 |0810 |1 |F |Add 3GPP-Charging-ID to RAN Secondary RAT
Usage Report |15.4.0 | |2018-09 |SA#81 |SP-180835 |0811 |1 |B |Introduction
 of reporting and reacting overload handling |15.4.0 | |2018-09 |SA#81 |SP-
   180835 |0812 |2 |B |Introduction of AVP for Overload Control |15.4.0 |
|2018-09 |SA#81 |SP-180835 |0813 |1 |B |Introduction of overload AVP
description |15.4.0 | |2018-12 |SA#82 |SP-181041 |0814 |1 |F |Correction on
 reporting UE-dedicated PRA(s) to OCS   |15.5.0 | |2018-12 |SA#82 |SP-181041
  |0815 |1 |F |Correction on multiple PRA(s) in offline charging |15.5.0 |
|2018-12 |SA#82 |SP-181058 |0816 |1 |F |Solve Editor's Note on Access
  Network charging Identifier |15.5.0 | |2018-12 |SA#82 |SP-181058 |0817 |1
|F |Correction on the TTRL and TLTRL |15.5.0 | |2019-03 |SA#83 |SP-190113
  |0818 |- |F |Correction of GGSN field for SMF address  |15.6.0 | |2019-03
|SA#83 |SP-190195 |0819 |- | F |Correction of missing Presence-Reporting-
Area-Node AVP  |15.6.0 | |2019-03 |SA#83 |SP-190129 |0820 |1 |B |Support
status of VoLTE service delivery |16.0.0 | |2019-06 |SA#84 |SP-190379 |0822
|- |A |Adding Rate-Control information and triggers to Rf offline charging
|16.1.0 | |



